# $Id$
# Maintainer: Felix Yan <felixonmars@gmail.com>
# Contributor: cuihao <cuihao dot leo at gmail dot com>
# Contributor: Guten <ywzhaifei@gmail.com> 

pkgname=goagent
pkgver=2.1.13
pkgrel=2
pkgdesc="A gae proxy forked from gappproxy/wallproxy"
arch=("any")
url="http://goagent.googlecode.com"
license=("GPL2")
depends=('python2' 'python2-pyopenssl')
optdepends=('python2-gevent-beta: Optional Gevent Support')
conflicts=('python2-gevent<=0.99')
source=(
  "$pkgname.service"
  "https://github.com/goagent/goagent/archive/v$pkgver.tar.gz"
)
backup=('etc/goagent')
install=goagent.install

package() {
  cd "$srcdir/$pkgname-$pkgver"

  # python2 fix
  sed -i -re "1s/python2?/python2/" local/*.py
  chmod +x local/proxy.py

  mkdir -p "$pkgdir/opt/goagent"
  cp -r local server "$pkgdir/opt/goagent"
  
  # remove windows-only files
  rm -f "$pkgdir/opt/goagent/"*/*.{vbs,dll,exe,manifest,bat}
  rm -f "$pkgdir/opt/goagent/local/python27.zip"

  # remove mac-only files
  rm -f "$pkgdir/opt/goagent/local/addto-startup.py"

  # remove goagent-gtk
  rm -f "$pkgdir/opt/goagent/local/goagent-gtk.py"
  rm -f "$pkgdir/opt/goagent/local/logo.png"

  # remove CA.crt CA.key for security issues
  rm -f "$pkgdir/opt/goagent/local/CA.crt" "$pkgdir/opt/goagent/local/CA.key"
  rm -rf "$pkgdir/opt/goagent/local/certs"

  # config file
  install -Dm644 "${pkgdir}/opt/goagent/local/proxy.ini" "${pkgdir}/etc/goagent"
  ln -sf "/etc/goagent" "${pkgdir}/opt/goagent/local/proxy.ini"

  # systemd service
  install -Dm644 "${srcdir}/goagent.service" "${pkgdir}/usr/lib/systemd/system/goagent.service"
}

# vim:set ts=2 sw=2 et:
md5sums=('e49aca604fcbf7b64d07460d33669640'
         '2d9a13fde523a6da4bcbab4f45569260')
