From 5ba1da0ba339e9a2e90f7f66e08fefb6a29173e6 Mon Sep 17 00:00:00 2001
From: Volker Braun <vbraun.name@gmail.com>
Date: Tue, 17 Feb 2015 00:14:03 +0100
Subject: [PATCH] update to gap 4.7.7

---
 INSTALL          |   4 +-
 Makefile.in      |  11 +-
 README           |   2 +-
 aclocal.m4       | 154 ++++++++++++++++++++-------
 config.guess     | 313 ++++++++++++++++++-------------------------------------
 config.sub       |  56 +++++-----
 configure        | 247 ++++++++++++++++++++-----------------------
 configure.ac     |   2 +-
 missing          |   4 +-
 src/Makefile.in  |  10 +-
 src/compiled.h   |  10 ++
 src/config.h.in  |   3 -
 src/gap.c        |  19 +++-
 src/gap.h        |   1 +
 src/gasman.c     |  52 +++++++--
 src/gasman.h     |  16 +++
 src/gmpints.c    |  13 ++-
 src/gmpints.h    |   7 ++
 src/integer.c    |  27 +----
 src/integer.h    |   2 +-
 src/intfuncs.c   |   2 +-
 src/objfgelm.h   |  24 +++--
 src/objscoll.c   |   6 +-
 src/opers.c      |   8 +-
 src/pperm.c      | 226 ++++++++++++++++++++++++---------------
 src/string.c     |  70 ++++++++++---
 src/string.h     |  11 ++
 src/system.c     |  19 +++-
 src/trans.c      | 139 ++++++++++++------------
 src/trans.h      |  21 ++++
 test-driver      |  20 +++-
 test/Makefile.in |   6 +-
 32 files changed, 841 insertions(+), 664 deletions(-)

diff --git a/INSTALL b/INSTALL
index 007e939..2099840 100644
--- a/INSTALL
+++ b/INSTALL
@@ -12,8 +12,8 @@ without warranty of any kind.
 Basic Installation
 ==================
 
-   Briefly, the shell commands `./configure; make; make install' should
-configure, build, and install this package.  The following
+   Briefly, the shell command `./configure && make && make install'
+should configure, build, and install this package.  The following
 more-detailed instructions are generic; see the `README' file for
 instructions specific to this package.  Some packages provide this
 `INSTALL' file but do not implement all of the features documented
diff --git a/Makefile.in b/Makefile.in
index 9e66fe3..5f51a0f 100644
--- a/Makefile.in
+++ b/Makefile.in
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.13.4 from Makefile.am.
+# Makefile.in generated by automake 1.14.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994-2013 Free Software Foundation, Inc.
@@ -564,10 +564,16 @@ dist-xz: distdir
 	$(am__post_remove_distdir)
 
 dist-tarZ: distdir
+	@echo WARNING: "Support for shar distribution archives is" \
+	               "deprecated." >&2
+	@echo WARNING: "It will be removed altogether in Automake 2.0" >&2
 	tardir=$(distdir) && $(am__tar) | compress -c >$(distdir).tar.Z
 	$(am__post_remove_distdir)
 
 dist-shar: distdir
+	@echo WARNING: "Support for distribution archives compressed with" \
+		       "legacy program 'compress' is deprecated." >&2
+	@echo WARNING: "It will be removed altogether in Automake 2.0" >&2
 	shar $(distdir) | GZIP=$(GZIP_ENV) gzip -c >$(distdir).shar.gz
 	$(am__post_remove_distdir)
 
@@ -609,9 +615,10 @@ distcheck: dist
 	  && dc_destdir="$${TMPDIR-/tmp}/am-dc-$$$$/" \
 	  && am__cwd=`pwd` \
 	  && $(am__cd) $(distdir)/_build \
-	  && ../configure --srcdir=.. --prefix="$$dc_install_base" \
+	  && ../configure \
 	    $(AM_DISTCHECK_CONFIGURE_FLAGS) \
 	    $(DISTCHECK_CONFIGURE_FLAGS) \
+	    --srcdir=.. --prefix="$$dc_install_base" \
 	  && $(MAKE) $(AM_MAKEFLAGS) \
 	  && $(MAKE) $(AM_MAKEFLAGS) dvi \
 	  && $(MAKE) $(AM_MAKEFLAGS) check \
diff --git a/README b/README
index 6f234b6..0cda4da 100644
--- a/README
+++ b/README
@@ -75,7 +75,7 @@ the following steps:
   4. Apply patches/gap-x.y.z.patch to the new src
      directory. Hopefully, there are no conflicts. Good luck!
 
-         $ patch -p0 < patches/gap-x.y.z.patch
+         $ cd src && patch -p1 < ../patches/gap-x.y.z.patch
 
   5. Update src/Makefile.am if C sources have been added/removed.
 
diff --git a/aclocal.m4 b/aclocal.m4
index 5a76efc..45a2903 100644
--- a/aclocal.m4
+++ b/aclocal.m4
@@ -1,4 +1,4 @@
-# generated automatically by aclocal 1.13.4 -*- Autoconf -*-
+# generated automatically by aclocal 1.14.1 -*- Autoconf -*-
 
 # Copyright (C) 1996-2013 Free Software Foundation, Inc.
 
@@ -32,10 +32,10 @@ To do so, use the procedure documented by the package, typically 'autoreconf'.])
 # generated from the m4 files accompanying Automake X.Y.
 # (This private macro should not be called outside this file.)
 AC_DEFUN([AM_AUTOMAKE_VERSION],
-[am__api_version='1.13'
+[am__api_version='1.14'
 dnl Some users find AM_AUTOMAKE_VERSION and mistake it for a way to
 dnl require some minimum version.  Point them to the right macro.
-m4_if([$1], [1.13.4], [],
+m4_if([$1], [1.14.1], [],
       [AC_FATAL([Do not call $0, use AM_INIT_AUTOMAKE([$1]).])])dnl
 ])
 
@@ -51,7 +51,7 @@ m4_define([_AM_AUTOCONF_VERSION], [])
 # Call AM_AUTOMAKE_VERSION and AM_AUTOMAKE_VERSION so they can be traced.
 # This function is AC_REQUIREd by AM_INIT_AUTOMAKE.
 AC_DEFUN([AM_SET_CURRENT_AUTOMAKE_VERSION],
-[AM_AUTOMAKE_VERSION([1.13.4])dnl
+[AM_AUTOMAKE_VERSION([1.14.1])dnl
 m4_ifndef([AC_AUTOCONF_VERSION],
   [m4_copy([m4_PACKAGE_VERSION], [AC_AUTOCONF_VERSION])])dnl
 _AM_AUTOCONF_VERSION(m4_defn([AC_AUTOCONF_VERSION]))])
@@ -438,6 +438,12 @@ AC_DEFUN([AM_OUTPUT_DEPENDENCY_COMMANDS],
 # This macro actually does too much.  Some checks are only needed if
 # your package does certain things.  But this isn't really a big deal.
 
+dnl Redefine AC_PROG_CC to automatically invoke _AM_PROG_CC_C_O.
+m4_define([AC_PROG_CC],
+m4_defn([AC_PROG_CC])
+[_AM_PROG_CC_C_O
+])
+
 # AM_INIT_AUTOMAKE(PACKAGE, VERSION, [NO-DEFINE])
 # AM_INIT_AUTOMAKE([OPTIONS])
 # -----------------------------------------------
@@ -546,7 +552,48 @@ dnl macro is hooked onto _AC_COMPILER_EXEEXT early, see below.
 AC_CONFIG_COMMANDS_PRE(dnl
 [m4_provide_if([_AM_COMPILER_EXEEXT],
   [AM_CONDITIONAL([am__EXEEXT], [test -n "$EXEEXT"])])])dnl
-])
+
+# POSIX will say in a future version that running "rm -f" with no argument
+# is OK; and we want to be able to make that assumption in our Makefile
+# recipes.  So use an aggressive probe to check that the usage we want is
+# actually supported "in the wild" to an acceptable degree.
+# See automake bug#10828.
+# To make any issue more visible, cause the running configure to be aborted
+# by default if the 'rm' program in use doesn't match our expectations; the
+# user can still override this though.
+if rm -f && rm -fr && rm -rf; then : OK; else
+  cat >&2 <<'END'
+Oops!
+
+Your 'rm' program seems unable to run without file operands specified
+on the command line, even when the '-f' option is present.  This is contrary
+to the behaviour of most rm programs out there, and not conforming with
+the upcoming POSIX standard: <http://austingroupbugs.net/view.php?id=542>
+
+Please tell bug-automake@gnu.org about your system, including the value
+of your $PATH and any error possibly output before this message.  This
+can help us improve future automake versions.
+
+END
+  if test x"$ACCEPT_INFERIOR_RM_PROGRAM" = x"yes"; then
+    echo 'Configuration will proceed anyway, since you have set the' >&2
+    echo 'ACCEPT_INFERIOR_RM_PROGRAM variable to "yes"' >&2
+    echo >&2
+  else
+    cat >&2 <<'END'
+Aborting the configuration process, to ensure you take notice of the issue.
+
+You can download and install GNU coreutils to get an 'rm' implementation
+that behaves properly: <http://www.gnu.org/software/coreutils/>.
+
+If you want to complete the configuration process using your problematic
+'rm' anyway, export the environment variable ACCEPT_INFERIOR_RM_PROGRAM
+to "yes", and re-run configure.
+
+END
+    AC_MSG_ERROR([Your 'rm' program is bad, sorry.])
+  fi
+fi])
 
 dnl Hook into '_AC_COMPILER_EXEEXT' early to learn its expansion.  Do not
 dnl add the conditional right here, as _AC_COMPILER_EXEEXT may be further
@@ -554,7 +601,6 @@ dnl mangled by Autoconf and run in a shell conditional statement.
 m4_define([_AC_COMPILER_EXEEXT],
 m4_defn([_AC_COMPILER_EXEEXT])[m4_provide([_AM_COMPILER_EXEEXT])])
 
-
 # When config.status generates a header, we must update the stamp-h file.
 # This file resides in the same directory as the config header
 # that is generated.  The stamp files are numbered to have different names.
@@ -666,38 +712,6 @@ AC_MSG_RESULT([$_am_result])
 rm -f confinc confmf
 ])
 
-# Copyright (C) 1999-2013 Free Software Foundation, Inc.
-#
-# This file is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# AM_PROG_CC_C_O
-# --------------
-# Like AC_PROG_CC_C_O, but changed for automake.
-AC_DEFUN([AM_PROG_CC_C_O],
-[AC_REQUIRE([AC_PROG_CC_C_O])dnl
-AC_REQUIRE([AM_AUX_DIR_EXPAND])dnl
-AC_REQUIRE_AUX_FILE([compile])dnl
-# FIXME: we rely on the cache variable name because
-# there is no other way.
-set dummy $CC
-am_cc=`echo $[2] | sed ['s/[^a-zA-Z0-9_]/_/g;s/^[0-9]/_/']`
-eval am_t=\$ac_cv_prog_cc_${am_cc}_c_o
-if test "$am_t" != yes; then
-   # Losing compiler, so override with the script.
-   # FIXME: It is wrong to rewrite CC.
-   # But if we don't then we get into trouble of one sort or another.
-   # A longer-term fix would be to have automake use am__CC in this case,
-   # and then we could set am__CC="\$(top_srcdir)/compile \$(CC)"
-   CC="$am_aux_dir/compile $CC"
-fi
-dnl Make sure AC_PROG_CC is never called again, or it will override our
-dnl setting of CC.
-m4_define([AC_PROG_CC],
-          [m4_fatal([AC_PROG_CC cannot be called after AM_PROG_CC_C_O])])
-])
-
 # Fake the existence of programs that GNU maintainers use.  -*- Autoconf -*-
 
 # Copyright (C) 1997-2013 Free Software Foundation, Inc.
@@ -768,6 +782,70 @@ AC_DEFUN([_AM_SET_OPTIONS],
 AC_DEFUN([_AM_IF_OPTION],
 [m4_ifset(_AM_MANGLE_OPTION([$1]), [$2], [$3])])
 
+# Copyright (C) 1999-2013 Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# _AM_PROG_CC_C_O
+# ---------------
+# Like AC_PROG_CC_C_O, but changed for automake.  We rewrite AC_PROG_CC
+# to automatically call this.
+AC_DEFUN([_AM_PROG_CC_C_O],
+[AC_REQUIRE([AM_AUX_DIR_EXPAND])dnl
+AC_REQUIRE_AUX_FILE([compile])dnl
+AC_LANG_PUSH([C])dnl
+AC_CACHE_CHECK(
+  [whether $CC understands -c and -o together],
+  [am_cv_prog_cc_c_o],
+  [AC_LANG_CONFTEST([AC_LANG_PROGRAM([])])
+  # Make sure it works both with $CC and with simple cc.
+  # Following AC_PROG_CC_C_O, we do the test twice because some
+  # compilers refuse to overwrite an existing .o file with -o,
+  # though they will create one.
+  am_cv_prog_cc_c_o=yes
+  for am_i in 1 2; do
+    if AM_RUN_LOG([$CC -c conftest.$ac_ext -o conftest2.$ac_objext]) \
+         && test -f conftest2.$ac_objext; then
+      : OK
+    else
+      am_cv_prog_cc_c_o=no
+      break
+    fi
+  done
+  rm -f core conftest*
+  unset am_i])
+if test "$am_cv_prog_cc_c_o" != yes; then
+   # Losing compiler, so override with the script.
+   # FIXME: It is wrong to rewrite CC.
+   # But if we don't then we get into trouble of one sort or another.
+   # A longer-term fix would be to have automake use am__CC in this case,
+   # and then we could set am__CC="\$(top_srcdir)/compile \$(CC)"
+   CC="$am_aux_dir/compile $CC"
+fi
+AC_LANG_POP([C])])
+
+# For backward compatibility.
+AC_DEFUN_ONCE([AM_PROG_CC_C_O], [AC_REQUIRE([AC_PROG_CC])])
+
+# Copyright (C) 2001-2013 Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# AM_RUN_LOG(COMMAND)
+# -------------------
+# Run COMMAND, save the exit status in ac_status, and log it.
+# (This has been adapted from Autoconf's _AC_RUN_LOG macro.)
+AC_DEFUN([AM_RUN_LOG],
+[{ echo "$as_me:$LINENO: $1" >&AS_MESSAGE_LOG_FD
+   ($1) >&AS_MESSAGE_LOG_FD 2>&AS_MESSAGE_LOG_FD
+   ac_status=$?
+   echo "$as_me:$LINENO: \$? = $ac_status" >&AS_MESSAGE_LOG_FD
+   (exit $ac_status); }])
+
 # Check to make sure that the build environment is sane.    -*- Autoconf -*-
 
 # Copyright (C) 1996-2013 Free Software Foundation, Inc.
diff --git a/config.guess b/config.guess
index 1804e9f..1f5c50c 100755
--- a/config.guess
+++ b/config.guess
@@ -1,10 +1,8 @@
 #! /bin/sh
 # Attempt to guess a canonical system name.
-#   Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999,
-#   2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
-#   2011, 2012, 2013 Free Software Foundation, Inc.
+#   Copyright 1992-2014 Free Software Foundation, Inc.
 
-timestamp='2012-12-29'
+timestamp='2014-03-23'
 
 # This file is free software; you can redistribute it and/or modify it
 # under the terms of the GNU General Public License as published by
@@ -26,7 +24,7 @@ timestamp='2012-12-29'
 # program.  This Exception is an additional permission under section 7
 # of the GNU General Public License, version 3 ("GPLv3").
 #
-# Originally written by Per Bothner. 
+# Originally written by Per Bothner.
 #
 # You can get the latest version of this script from:
 # http://git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.guess;hb=HEAD
@@ -52,9 +50,7 @@ version="\
 GNU config.guess ($timestamp)
 
 Originally written by Per Bothner.
-Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000,
-2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011,
-2012, 2013 Free Software Foundation, Inc.
+Copyright 1992-2014 Free Software Foundation, Inc.
 
 This is free software; see the source for copying conditions.  There is NO
 warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE."
@@ -136,6 +132,27 @@ UNAME_RELEASE=`(uname -r) 2>/dev/null` || UNAME_RELEASE=unknown
 UNAME_SYSTEM=`(uname -s) 2>/dev/null`  || UNAME_SYSTEM=unknown
 UNAME_VERSION=`(uname -v) 2>/dev/null` || UNAME_VERSION=unknown
 
+case "${UNAME_SYSTEM}" in
+Linux|GNU|GNU/*)
+	# If the system lacks a compiler, then just pick glibc.
+	# We could probably try harder.
+	LIBC=gnu
+
+	eval $set_cc_for_build
+	cat <<-EOF > $dummy.c
+	#include <features.h>
+	#if defined(__UCLIBC__)
+	LIBC=uclibc
+	#elif defined(__dietlibc__)
+	LIBC=dietlibc
+	#else
+	LIBC=gnu
+	#endif
+	EOF
+	eval `$CC_FOR_BUILD -E $dummy.c 2>/dev/null | grep '^LIBC' | sed 's, ,,g'`
+	;;
+esac
+
 # Note: order is significant - the case branches are not exclusive.
 
 case "${UNAME_MACHINE}:${UNAME_SYSTEM}:${UNAME_RELEASE}:${UNAME_VERSION}" in
@@ -809,7 +826,7 @@ EOF
     *:MINGW*:*)
 	echo ${UNAME_MACHINE}-pc-mingw32
 	exit ;;
-    i*:MSYS*:*)
+    *:MSYS*:*)
 	echo ${UNAME_MACHINE}-pc-msys
 	exit ;;
     i*:windows32*:*)
@@ -857,21 +874,21 @@ EOF
 	exit ;;
     *:GNU:*:*)
 	# the GNU system
-	echo `echo ${UNAME_MACHINE}|sed -e 's,[-/].*$,,'`-unknown-gnu`echo ${UNAME_RELEASE}|sed -e 's,/.*$,,'`
+	echo `echo ${UNAME_MACHINE}|sed -e 's,[-/].*$,,'`-unknown-${LIBC}`echo ${UNAME_RELEASE}|sed -e 's,/.*$,,'`
 	exit ;;
     *:GNU/*:*:*)
 	# other systems with GNU libc and userland
-	echo ${UNAME_MACHINE}-unknown-`echo ${UNAME_SYSTEM} | sed 's,^[^/]*/,,' | tr '[A-Z]' '[a-z]'``echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'`-gnu
+	echo ${UNAME_MACHINE}-unknown-`echo ${UNAME_SYSTEM} | sed 's,^[^/]*/,,' | tr '[A-Z]' '[a-z]'``echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'`-${LIBC}
 	exit ;;
     i*86:Minix:*:*)
 	echo ${UNAME_MACHINE}-pc-minix
 	exit ;;
     aarch64:Linux:*:*)
-	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
 	exit ;;
     aarch64_be:Linux:*:*)
 	UNAME_MACHINE=aarch64_be
-	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
 	exit ;;
     alpha:Linux:*:*)
 	case `sed -n '/^cpu model/s/^.*: \(.*\)/\1/p' < /proc/cpuinfo` in
@@ -884,59 +901,54 @@ EOF
 	  EV68*) UNAME_MACHINE=alphaev68 ;;
 	esac
 	objdump --private-headers /bin/sh | grep -q ld.so.1
-	if test "$?" = 0 ; then LIBC="libc1" ; else LIBC="" ; fi
-	echo ${UNAME_MACHINE}-unknown-linux-gnu${LIBC}
+	if test "$?" = 0 ; then LIBC="gnulibc1" ; fi
+	echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
+	exit ;;
+    arc:Linux:*:* | arceb:Linux:*:*)
+	echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
 	exit ;;
     arm*:Linux:*:*)
 	eval $set_cc_for_build
 	if echo __ARM_EABI__ | $CC_FOR_BUILD -E - 2>/dev/null \
 	    | grep -q __ARM_EABI__
 	then
-	    echo ${UNAME_MACHINE}-unknown-linux-gnu
+	    echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
 	else
 	    if echo __ARM_PCS_VFP | $CC_FOR_BUILD -E - 2>/dev/null \
 		| grep -q __ARM_PCS_VFP
 	    then
-		echo ${UNAME_MACHINE}-unknown-linux-gnueabi
+		echo ${UNAME_MACHINE}-unknown-linux-${LIBC}eabi
 	    else
-		echo ${UNAME_MACHINE}-unknown-linux-gnueabihf
+		echo ${UNAME_MACHINE}-unknown-linux-${LIBC}eabihf
 	    fi
 	fi
 	exit ;;
     avr32*:Linux:*:*)
-	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
 	exit ;;
     cris:Linux:*:*)
-	echo ${UNAME_MACHINE}-axis-linux-gnu
+	echo ${UNAME_MACHINE}-axis-linux-${LIBC}
 	exit ;;
     crisv32:Linux:*:*)
-	echo ${UNAME_MACHINE}-axis-linux-gnu
+	echo ${UNAME_MACHINE}-axis-linux-${LIBC}
 	exit ;;
     frv:Linux:*:*)
-	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
 	exit ;;
     hexagon:Linux:*:*)
-	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
 	exit ;;
     i*86:Linux:*:*)
-	LIBC=gnu
-	eval $set_cc_for_build
-	sed 's/^	//' << EOF >$dummy.c
-	#ifdef __dietlibc__
-	LIBC=dietlibc
-	#endif
-EOF
-	eval `$CC_FOR_BUILD -E $dummy.c 2>/dev/null | grep '^LIBC'`
-	echo "${UNAME_MACHINE}-pc-linux-${LIBC}"
+	echo ${UNAME_MACHINE}-pc-linux-${LIBC}
 	exit ;;
     ia64:Linux:*:*)
-	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
 	exit ;;
     m32r*:Linux:*:*)
-	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
 	exit ;;
     m68*:Linux:*:*)
-	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
 	exit ;;
     mips:Linux:*:* | mips64:Linux:*:*)
 	eval $set_cc_for_build
@@ -955,54 +967,63 @@ EOF
 	#endif
 EOF
 	eval `$CC_FOR_BUILD -E $dummy.c 2>/dev/null | grep '^CPU'`
-	test x"${CPU}" != x && { echo "${CPU}-unknown-linux-gnu"; exit; }
+	test x"${CPU}" != x && { echo "${CPU}-unknown-linux-${LIBC}"; exit; }
 	;;
-    or32:Linux:*:*)
-	echo ${UNAME_MACHINE}-unknown-linux-gnu
+    openrisc*:Linux:*:*)
+	echo or1k-unknown-linux-${LIBC}
+	exit ;;
+    or32:Linux:*:* | or1k*:Linux:*:*)
+	echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
 	exit ;;
     padre:Linux:*:*)
-	echo sparc-unknown-linux-gnu
+	echo sparc-unknown-linux-${LIBC}
 	exit ;;
     parisc64:Linux:*:* | hppa64:Linux:*:*)
-	echo hppa64-unknown-linux-gnu
+	echo hppa64-unknown-linux-${LIBC}
 	exit ;;
     parisc:Linux:*:* | hppa:Linux:*:*)
 	# Look for CPU level
 	case `grep '^cpu[^a-z]*:' /proc/cpuinfo 2>/dev/null | cut -d' ' -f2` in
-	  PA7*) echo hppa1.1-unknown-linux-gnu ;;
-	  PA8*) echo hppa2.0-unknown-linux-gnu ;;
-	  *)    echo hppa-unknown-linux-gnu ;;
+	  PA7*) echo hppa1.1-unknown-linux-${LIBC} ;;
+	  PA8*) echo hppa2.0-unknown-linux-${LIBC} ;;
+	  *)    echo hppa-unknown-linux-${LIBC} ;;
 	esac
 	exit ;;
     ppc64:Linux:*:*)
-	echo powerpc64-unknown-linux-gnu
+	echo powerpc64-unknown-linux-${LIBC}
 	exit ;;
     ppc:Linux:*:*)
-	echo powerpc-unknown-linux-gnu
+	echo powerpc-unknown-linux-${LIBC}
+	exit ;;
+    ppc64le:Linux:*:*)
+	echo powerpc64le-unknown-linux-${LIBC}
+	exit ;;
+    ppcle:Linux:*:*)
+	echo powerpcle-unknown-linux-${LIBC}
 	exit ;;
     s390:Linux:*:* | s390x:Linux:*:*)
-	echo ${UNAME_MACHINE}-ibm-linux
+	echo ${UNAME_MACHINE}-ibm-linux-${LIBC}
 	exit ;;
     sh64*:Linux:*:*)
-	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
 	exit ;;
     sh*:Linux:*:*)
-	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
 	exit ;;
     sparc:Linux:*:* | sparc64:Linux:*:*)
-	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
 	exit ;;
     tile*:Linux:*:*)
-	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
 	exit ;;
     vax:Linux:*:*)
-	echo ${UNAME_MACHINE}-dec-linux-gnu
+	echo ${UNAME_MACHINE}-dec-linux-${LIBC}
 	exit ;;
     x86_64:Linux:*:*)
-	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
 	exit ;;
     xtensa*:Linux:*:*)
-	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
 	exit ;;
     i*86:DYNIX/ptx:4*:*)
 	# ptx 4.0 does uname -s correctly, with DYNIX/ptx in there.
@@ -1235,19 +1256,31 @@ EOF
 	exit ;;
     *:Darwin:*:*)
 	UNAME_PROCESSOR=`uname -p` || UNAME_PROCESSOR=unknown
-	case $UNAME_PROCESSOR in
-	    i386)
-		eval $set_cc_for_build
-		if [ "$CC_FOR_BUILD" != 'no_compiler_found' ]; then
-		  if (echo '#ifdef __LP64__'; echo IS_64BIT_ARCH; echo '#endif') | \
-		      (CCOPTS= $CC_FOR_BUILD -E - 2>/dev/null) | \
-		      grep IS_64BIT_ARCH >/dev/null
-		  then
-		      UNAME_PROCESSOR="x86_64"
-		  fi
-		fi ;;
-	    unknown) UNAME_PROCESSOR=powerpc ;;
-	esac
+	eval $set_cc_for_build
+	if test "$UNAME_PROCESSOR" = unknown ; then
+	    UNAME_PROCESSOR=powerpc
+	fi
+	if test `echo "$UNAME_RELEASE" | sed -e 's/\..*//'` -le 10 ; then
+	    if [ "$CC_FOR_BUILD" != 'no_compiler_found' ]; then
+		if (echo '#ifdef __LP64__'; echo IS_64BIT_ARCH; echo '#endif') | \
+		    (CCOPTS= $CC_FOR_BUILD -E - 2>/dev/null) | \
+		    grep IS_64BIT_ARCH >/dev/null
+		then
+		    case $UNAME_PROCESSOR in
+			i386) UNAME_PROCESSOR=x86_64 ;;
+			powerpc) UNAME_PROCESSOR=powerpc64 ;;
+		    esac
+		fi
+	    fi
+	elif test "$UNAME_PROCESSOR" = i386 ; then
+	    # Avoid executing cc on OS X 10.9, as it ships with a stub
+	    # that puts up a graphical alert prompting to install
+	    # developer tools.  Any system running Mac OS X 10.7 or
+	    # later (Darwin 11 and later) is required to have a 64-bit
+	    # processor. This is not true of the ARM version of Darwin
+	    # that Apple uses in portable devices.
+	    UNAME_PROCESSOR=x86_64
+	fi
 	echo ${UNAME_PROCESSOR}-apple-darwin${UNAME_RELEASE}
 	exit ;;
     *:procnto*:*:* | *:QNX:[0123456789]*:*)
@@ -1338,154 +1371,6 @@ EOF
 	exit ;;
 esac
 
-eval $set_cc_for_build
-cat >$dummy.c <<EOF
-#ifdef _SEQUENT_
-# include <sys/types.h>
-# include <sys/utsname.h>
-#endif
-main ()
-{
-#if defined (sony)
-#if defined (MIPSEB)
-  /* BFD wants "bsd" instead of "newsos".  Perhaps BFD should be changed,
-     I don't know....  */
-  printf ("mips-sony-bsd\n"); exit (0);
-#else
-#include <sys/param.h>
-  printf ("m68k-sony-newsos%s\n",
-#ifdef NEWSOS4
-	"4"
-#else
-	""
-#endif
-	); exit (0);
-#endif
-#endif
-
-#if defined (__arm) && defined (__acorn) && defined (__unix)
-  printf ("arm-acorn-riscix\n"); exit (0);
-#endif
-
-#if defined (hp300) && !defined (hpux)
-  printf ("m68k-hp-bsd\n"); exit (0);
-#endif
-
-#if defined (NeXT)
-#if !defined (__ARCHITECTURE__)
-#define __ARCHITECTURE__ "m68k"
-#endif
-  int version;
-  version=`(hostinfo | sed -n 's/.*NeXT Mach \([0-9]*\).*/\1/p') 2>/dev/null`;
-  if (version < 4)
-    printf ("%s-next-nextstep%d\n", __ARCHITECTURE__, version);
-  else
-    printf ("%s-next-openstep%d\n", __ARCHITECTURE__, version);
-  exit (0);
-#endif
-
-#if defined (MULTIMAX) || defined (n16)
-#if defined (UMAXV)
-  printf ("ns32k-encore-sysv\n"); exit (0);
-#else
-#if defined (CMU)
-  printf ("ns32k-encore-mach\n"); exit (0);
-#else
-  printf ("ns32k-encore-bsd\n"); exit (0);
-#endif
-#endif
-#endif
-
-#if defined (__386BSD__)
-  printf ("i386-pc-bsd\n"); exit (0);
-#endif
-
-#if defined (sequent)
-#if defined (i386)
-  printf ("i386-sequent-dynix\n"); exit (0);
-#endif
-#if defined (ns32000)
-  printf ("ns32k-sequent-dynix\n"); exit (0);
-#endif
-#endif
-
-#if defined (_SEQUENT_)
-    struct utsname un;
-
-    uname(&un);
-
-    if (strncmp(un.version, "V2", 2) == 0) {
-	printf ("i386-sequent-ptx2\n"); exit (0);
-    }
-    if (strncmp(un.version, "V1", 2) == 0) { /* XXX is V1 correct? */
-	printf ("i386-sequent-ptx1\n"); exit (0);
-    }
-    printf ("i386-sequent-ptx\n"); exit (0);
-
-#endif
-
-#if defined (vax)
-# if !defined (ultrix)
-#  include <sys/param.h>
-#  if defined (BSD)
-#   if BSD == 43
-      printf ("vax-dec-bsd4.3\n"); exit (0);
-#   else
-#    if BSD == 199006
-      printf ("vax-dec-bsd4.3reno\n"); exit (0);
-#    else
-      printf ("vax-dec-bsd\n"); exit (0);
-#    endif
-#   endif
-#  else
-    printf ("vax-dec-bsd\n"); exit (0);
-#  endif
-# else
-    printf ("vax-dec-ultrix\n"); exit (0);
-# endif
-#endif
-
-#if defined (alliant) && defined (i860)
-  printf ("i860-alliant-bsd\n"); exit (0);
-#endif
-
-  exit (1);
-}
-EOF
-
-$CC_FOR_BUILD -o $dummy $dummy.c 2>/dev/null && SYSTEM_NAME=`$dummy` &&
-	{ echo "$SYSTEM_NAME"; exit; }
-
-# Apollos put the system type in the environment.
-
-test -d /usr/apollo && { echo ${ISP}-apollo-${SYSTYPE}; exit; }
-
-# Convex versions that predate uname can use getsysinfo(1)
-
-if [ -x /usr/convex/getsysinfo ]
-then
-    case `getsysinfo -f cpu_type` in
-    c1*)
-	echo c1-convex-bsd
-	exit ;;
-    c2*)
-	if getsysinfo -f scalar_acc
-	then echo c32-convex-bsd
-	else echo c2-convex-bsd
-	fi
-	exit ;;
-    c34*)
-	echo c34-convex-bsd
-	exit ;;
-    c38*)
-	echo c38-convex-bsd
-	exit ;;
-    c4*)
-	echo c4-convex-bsd
-	exit ;;
-    esac
-fi
-
 cat >&2 <<EOF
 $0: unable to guess system type
 
diff --git a/config.sub b/config.sub
index 52f04bc..66c5074 100755
--- a/config.sub
+++ b/config.sub
@@ -1,10 +1,8 @@
 #! /bin/sh
 # Configuration validation subroutine script.
-#   Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999,
-#   2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
-#   2011, 2012, 2013 Free Software Foundation, Inc.
+#   Copyright 1992-2014 Free Software Foundation, Inc.
 
-timestamp='2012-12-29'
+timestamp='2014-07-28'
 
 # This file is free software; you can redistribute it and/or modify it
 # under the terms of the GNU General Public License as published by
@@ -70,9 +68,7 @@ Report bugs and patches to <config-patches@gnu.org>."
 version="\
 GNU config.sub ($timestamp)
 
-Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000,
-2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011,
-2012, 2013 Free Software Foundation, Inc.
+Copyright 1992-2014 Free Software Foundation, Inc.
 
 This is free software; see the source for copying conditions.  There is NO
 warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE."
@@ -256,12 +252,12 @@ case $basic_machine in
 	| alpha | alphaev[4-8] | alphaev56 | alphaev6[78] | alphapca5[67] \
 	| alpha64 | alpha64ev[4-8] | alpha64ev56 | alpha64ev6[78] | alpha64pca5[67] \
 	| am33_2.0 \
-	| arc \
+	| arc | arceb \
 	| arm | arm[bl]e | arme[lb] | armv[2-8] | armv[3-8][lb] | armv7[arm] \
 	| avr | avr32 \
 	| be32 | be64 \
 	| bfin \
-	| c4x | clipper \
+	| c4x | c8051 | clipper \
 	| d10v | d30v | dlx | dsp16xx \
 	| epiphany \
 	| fido | fr30 | frv \
@@ -269,6 +265,7 @@ case $basic_machine in
 	| hexagon \
 	| i370 | i860 | i960 | ia64 \
 	| ip2k | iq2000 \
+	| k1om \
 	| le32 | le64 \
 	| lm32 \
 	| m32c | m32r | m32rle | m68000 | m68k | m88k \
@@ -286,20 +283,22 @@ case $basic_machine in
 	| mips64vr5900 | mips64vr5900el \
 	| mipsisa32 | mipsisa32el \
 	| mipsisa32r2 | mipsisa32r2el \
+	| mipsisa32r6 | mipsisa32r6el \
 	| mipsisa64 | mipsisa64el \
 	| mipsisa64r2 | mipsisa64r2el \
+	| mipsisa64r6 | mipsisa64r6el \
 	| mipsisa64sb1 | mipsisa64sb1el \
 	| mipsisa64sr71k | mipsisa64sr71kel \
+	| mipsr5900 | mipsr5900el \
 	| mipstx39 | mipstx39el \
 	| mn10200 | mn10300 \
 	| moxie \
 	| mt \
 	| msp430 \
 	| nds32 | nds32le | nds32be \
-	| nios | nios2 \
+	| nios | nios2 | nios2eb | nios2el \
 	| ns16k | ns32k \
-	| open8 \
-	| or32 \
+	| open8 | or1k | or1knd | or32 \
 	| pdp10 | pdp11 | pj | pjl \
 	| powerpc | powerpc64 | powerpc64le | powerpcle \
 	| pyramid \
@@ -327,7 +326,7 @@ case $basic_machine in
 	c6x)
 		basic_machine=tic6x-unknown
 		;;
-	m6811 | m68hc11 | m6812 | m68hc12 | m68hcs12x | picochip)
+	m6811 | m68hc11 | m6812 | m68hc12 | m68hcs12x | nvptx | picochip)
 		basic_machine=$basic_machine-unknown
 		os=-none
 		;;
@@ -369,13 +368,13 @@ case $basic_machine in
 	| aarch64-* | aarch64_be-* \
 	| alpha-* | alphaev[4-8]-* | alphaev56-* | alphaev6[78]-* \
 	| alpha64-* | alpha64ev[4-8]-* | alpha64ev56-* | alpha64ev6[78]-* \
-	| alphapca5[67]-* | alpha64pca5[67]-* | arc-* \
+	| alphapca5[67]-* | alpha64pca5[67]-* | arc-* | arceb-* \
 	| arm-*  | armbe-* | armle-* | armeb-* | armv*-* \
 	| avr-* | avr32-* \
 	| be32-* | be64-* \
 	| bfin-* | bs2000-* \
 	| c[123]* | c30-* | [cjt]90-* | c4x-* \
-	| clipper-* | craynv-* | cydra-* \
+	| c8051-* | clipper-* | craynv-* | cydra-* \
 	| d10v-* | d30v-* | dlx-* \
 	| elxsi-* \
 	| f30[01]-* | f700-* | fido-* | fr30-* | frv-* | fx80-* \
@@ -384,6 +383,7 @@ case $basic_machine in
 	| hexagon-* \
 	| i*86-* | i860-* | i960-* | ia64-* \
 	| ip2k-* | iq2000-* \
+	| k1om-* \
 	| le32-* | le64-* \
 	| lm32-* \
 	| m32c-* | m32r-* | m32rle-* \
@@ -403,18 +403,22 @@ case $basic_machine in
 	| mips64vr5900-* | mips64vr5900el-* \
 	| mipsisa32-* | mipsisa32el-* \
 	| mipsisa32r2-* | mipsisa32r2el-* \
+	| mipsisa32r6-* | mipsisa32r6el-* \
 	| mipsisa64-* | mipsisa64el-* \
 	| mipsisa64r2-* | mipsisa64r2el-* \
+	| mipsisa64r6-* | mipsisa64r6el-* \
 	| mipsisa64sb1-* | mipsisa64sb1el-* \
 	| mipsisa64sr71k-* | mipsisa64sr71kel-* \
+	| mipsr5900-* | mipsr5900el-* \
 	| mipstx39-* | mipstx39el-* \
 	| mmix-* \
 	| mt-* \
 	| msp430-* \
 	| nds32-* | nds32le-* | nds32be-* \
-	| nios-* | nios2-* \
+	| nios-* | nios2-* | nios2eb-* | nios2el-* \
 	| none-* | np1-* | ns16k-* | ns32k-* \
 	| open8-* \
+	| or1k*-* \
 	| orion-* \
 	| pdp10-* | pdp11-* | pj-* | pjl-* | pn-* | power-* \
 	| powerpc-* | powerpc64-* | powerpc64le-* | powerpcle-* \
@@ -796,7 +800,7 @@ case $basic_machine in
 		os=-mingw64
 		;;
 	mingw32)
-		basic_machine=i386-pc
+		basic_machine=i686-pc
 		os=-mingw32
 		;;
 	mingw32ce)
@@ -824,6 +828,10 @@ case $basic_machine in
 		basic_machine=powerpc-unknown
 		os=-morphos
 		;;
+	moxiebox)
+		basic_machine=moxie-unknown
+		os=-moxiebox
+		;;
 	msdos)
 		basic_machine=i386-pc
 		os=-msdos
@@ -832,7 +840,7 @@ case $basic_machine in
 		basic_machine=`echo $basic_machine | sed -e 's/ms1-/mt-/'`
 		;;
 	msys)
-		basic_machine=i386-pc
+		basic_machine=i686-pc
 		os=-msys
 		;;
 	mvs)
@@ -1354,7 +1362,7 @@ case $os in
 	-gnu* | -bsd* | -mach* | -minix* | -genix* | -ultrix* | -irix* \
 	      | -*vms* | -sco* | -esix* | -isc* | -aix* | -cnk* | -sunos | -sunos[34]*\
 	      | -hpux* | -unos* | -osf* | -luna* | -dgux* | -auroraux* | -solaris* \
-	      | -sym* | -kopensolaris* \
+	      | -sym* | -kopensolaris* | -plan9* \
 	      | -amigaos* | -amigados* | -msdos* | -newsos* | -unicos* | -aof* \
 	      | -aos* | -aros* \
 	      | -nindy* | -vxsim* | -vxworks* | -ebmon* | -hms* | -mvs* \
@@ -1369,14 +1377,14 @@ case $os in
 	      | -cygwin* | -msys* | -pe* | -psos* | -moss* | -proelf* | -rtems* \
 	      | -mingw32* | -mingw64* | -linux-gnu* | -linux-android* \
 	      | -linux-newlib* | -linux-musl* | -linux-uclibc* \
-	      | -uxpv* | -beos* | -mpeix* | -udk* \
+	      | -uxpv* | -beos* | -mpeix* | -udk* | -moxiebox* \
 	      | -interix* | -uwin* | -mks* | -rhapsody* | -darwin* | -opened* \
 	      | -openstep* | -oskit* | -conix* | -pw32* | -nonstopux* \
 	      | -storm-chaos* | -tops10* | -tenex* | -tops20* | -its* \
 	      | -os2* | -vos* | -palmos* | -uclinux* | -nucleus* \
 	      | -morphos* | -superux* | -rtmk* | -rtmk-nova* | -windiss* \
 	      | -powermax* | -dnix* | -nx6 | -nx7 | -sei* | -dragonfly* \
-	      | -skyos* | -haiku* | -rdos* | -toppers* | -drops* | -es*)
+	      | -skyos* | -haiku* | -rdos* | -toppers* | -drops* | -es* | -tirtos*)
 	# Remember, each alternative MUST END IN *, to match a version number.
 		;;
 	-qnx*)
@@ -1500,9 +1508,6 @@ case $os in
 	-aros*)
 		os=-aros
 		;;
-	-kaos*)
-		os=-kaos
-		;;
 	-zvmoe)
 		os=-zvmoe
 		;;
@@ -1551,6 +1556,9 @@ case $basic_machine in
 	c4x-* | tic4x-*)
 		os=-coff
 		;;
+	c8051-*)
+		os=-elf
+		;;
 	hexagon-*)
 		os=-elf
 		;;
diff --git a/configure b/configure
index 63a1d94..bdb8568 100755
--- a/configure
+++ b/configure
@@ -1,6 +1,6 @@
 #! /bin/sh
 # Guess values for system-dependent variables and create Makefiles.
-# Generated by GNU Autoconf 2.69 for libGAP 4.7.5.1.
+# Generated by GNU Autoconf 2.69 for libGAP 4.7.7.
 #
 # Report bugs to <sage-devel@googlegroups.com>.
 #
@@ -590,8 +590,8 @@ MAKEFLAGS=
 # Identity of this package.
 PACKAGE_NAME='libGAP'
 PACKAGE_TARNAME='libgap'
-PACKAGE_VERSION='4.7.5.1'
-PACKAGE_STRING='libGAP 4.7.5.1'
+PACKAGE_VERSION='4.7.7'
+PACKAGE_STRING='libGAP 4.7.7'
 PACKAGE_BUGREPORT='sage-devel@googlegroups.com'
 PACKAGE_URL=''
 
@@ -1329,7 +1329,7 @@ if test "$ac_init_help" = "long"; then
   # Omit some internal or obsolete options to make the list less imposing.
   # This message is too long to be a string in the A/UX 3.1 sh.
   cat <<_ACEOF
-\`configure' configures libGAP 4.7.5.1 to adapt to many kinds of systems.
+\`configure' configures libGAP 4.7.7 to adapt to many kinds of systems.
 
 Usage: $0 [OPTION]... [VAR=VALUE]...
 
@@ -1400,7 +1400,7 @@ fi
 
 if test -n "$ac_init_help"; then
   case $ac_init_help in
-     short | recursive ) echo "Configuration of libGAP 4.7.5.1:";;
+     short | recursive ) echo "Configuration of libGAP 4.7.7:";;
    esac
   cat <<\_ACEOF
 
@@ -1512,7 +1512,7 @@ fi
 test -n "$ac_init_help" && exit $ac_status
 if $ac_init_version; then
   cat <<\_ACEOF
-libGAP configure 4.7.5.1
+libGAP configure 4.7.7
 generated by GNU Autoconf 2.69
 
 Copyright (C) 2012 Free Software Foundation, Inc.
@@ -2175,7 +2175,7 @@ cat >config.log <<_ACEOF
 This file contains any messages produced by compilers while
 running configure, to aid debugging if configure makes a mistake.
 
-It was created by libGAP $as_me 4.7.5.1, which was
+It was created by libGAP $as_me 4.7.7, which was
 generated by GNU Autoconf 2.69.  Invocation command line was
 
   $ $0 $@
@@ -2663,7 +2663,7 @@ test -n "$target_alias" &&
   test "$program_prefix$program_suffix$program_transform_name" = \
     NONENONEs,x,x, &&
   program_prefix=${target_alias}-
-am__api_version='1.13'
+am__api_version='1.14'
 
 # Find a good install program.  We prefer a C program (faster),
 # so one script is as good as another.  But avoid the broken or
@@ -3149,7 +3149,7 @@ fi
 
 # Define the identity of the package.
  PACKAGE='libgap'
- VERSION='4.7.5.1'
+ VERSION='4.7.7'
 
 
 cat >>confdefs.h <<_ACEOF
@@ -3200,6 +3200,47 @@ am__tar='$${TAR-tar} chof - "$$tardir"' am__untar='$${TAR-tar} xf -'
 
 
 
+# POSIX will say in a future version that running "rm -f" with no argument
+# is OK; and we want to be able to make that assumption in our Makefile
+# recipes.  So use an aggressive probe to check that the usage we want is
+# actually supported "in the wild" to an acceptable degree.
+# See automake bug#10828.
+# To make any issue more visible, cause the running configure to be aborted
+# by default if the 'rm' program in use doesn't match our expectations; the
+# user can still override this though.
+if rm -f && rm -fr && rm -rf; then : OK; else
+  cat >&2 <<'END'
+Oops!
+
+Your 'rm' program seems unable to run without file operands specified
+on the command line, even when the '-f' option is present.  This is contrary
+to the behaviour of most rm programs out there, and not conforming with
+the upcoming POSIX standard: <http://austingroupbugs.net/view.php?id=542>
+
+Please tell bug-automake@gnu.org about your system, including the value
+of your $PATH and any error possibly output before this message.  This
+can help us improve future automake versions.
+
+END
+  if test x"$ACCEPT_INFERIOR_RM_PROGRAM" = x"yes"; then
+    echo 'Configuration will proceed anyway, since you have set the' >&2
+    echo 'ACCEPT_INFERIOR_RM_PROGRAM variable to "yes"' >&2
+    echo >&2
+  else
+    cat >&2 <<'END'
+Aborting the configuration process, to ensure you take notice of the issue.
+
+You can download and install GNU coreutils to get an 'rm' implementation
+that behaves properly: <http://www.gnu.org/software/coreutils/>.
+
+If you want to complete the configuration process using your problematic
+'rm' anyway, export the environment variable ACCEPT_INFERIOR_RM_PROGRAM
+to "yes", and re-run configure.
+
+END
+    as_fn_error $? "Your 'rm' program is bad, sorry." "$LINENO" 5
+  fi
+fi
 
 
 
@@ -4062,6 +4103,65 @@ ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
 ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
 ac_compiler_gnu=$ac_cv_c_compiler_gnu
 
+ac_ext=c
+ac_cpp='$CPP $CPPFLAGS'
+ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
+ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
+ac_compiler_gnu=$ac_cv_c_compiler_gnu
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether $CC understands -c and -o together" >&5
+$as_echo_n "checking whether $CC understands -c and -o together... " >&6; }
+if ${am_cv_prog_cc_c_o+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+
+int
+main ()
+{
+
+  ;
+  return 0;
+}
+_ACEOF
+  # Make sure it works both with $CC and with simple cc.
+  # Following AC_PROG_CC_C_O, we do the test twice because some
+  # compilers refuse to overwrite an existing .o file with -o,
+  # though they will create one.
+  am_cv_prog_cc_c_o=yes
+  for am_i in 1 2; do
+    if { echo "$as_me:$LINENO: $CC -c conftest.$ac_ext -o conftest2.$ac_objext" >&5
+   ($CC -c conftest.$ac_ext -o conftest2.$ac_objext) >&5 2>&5
+   ac_status=$?
+   echo "$as_me:$LINENO: \$? = $ac_status" >&5
+   (exit $ac_status); } \
+         && test -f conftest2.$ac_objext; then
+      : OK
+    else
+      am_cv_prog_cc_c_o=no
+      break
+    fi
+  done
+  rm -f core conftest*
+  unset am_i
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $am_cv_prog_cc_c_o" >&5
+$as_echo "$am_cv_prog_cc_c_o" >&6; }
+if test "$am_cv_prog_cc_c_o" != yes; then
+   # Losing compiler, so override with the script.
+   # FIXME: It is wrong to rewrite CC.
+   # But if we don't then we get into trouble of one sort or another.
+   # A longer-term fix would be to have automake use am__CC in this case,
+   # and then we could set am__CC="\$(top_srcdir)/compile \$(CC)"
+   CC="$am_aux_dir/compile $CC"
+fi
+ac_ext=c
+ac_cpp='$CPP $CPPFLAGS'
+ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
+ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
+ac_compiler_gnu=$ac_cv_c_compiler_gnu
+
+
 depcc="$CC"   am_compiler_list=
 
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking dependency style of $depcc" >&5
@@ -4306,131 +4406,6 @@ $as_echo "#define HAVE_SLASH_SEPARATOR 1" >>confdefs.h
 
 
 # Checks for programs.
-if test "x$CC" != xcc; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether $CC and cc understand -c and -o together" >&5
-$as_echo_n "checking whether $CC and cc understand -c and -o together... " >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether cc understands -c and -o together" >&5
-$as_echo_n "checking whether cc understands -c and -o together... " >&6; }
-fi
-set dummy $CC; ac_cc=`$as_echo "$2" |
-		      sed 's/[^a-zA-Z0-9_]/_/g;s/^[0-9]/_/'`
-if eval \${ac_cv_prog_cc_${ac_cc}_c_o+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-int
-main ()
-{
-
-  ;
-  return 0;
-}
-_ACEOF
-# Make sure it works both with $CC and with simple cc.
-# We do the test twice because some compilers refuse to overwrite an
-# existing .o file with -o, though they will create one.
-ac_try='$CC -c conftest.$ac_ext -o conftest2.$ac_objext >&5'
-rm -f conftest2.*
-if { { case "(($ac_try" in
-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
-  *) ac_try_echo=$ac_try;;
-esac
-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
-$as_echo "$ac_try_echo"; } >&5
-  (eval "$ac_try") 2>&5
-  ac_status=$?
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; } &&
-   test -f conftest2.$ac_objext && { { case "(($ac_try" in
-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
-  *) ac_try_echo=$ac_try;;
-esac
-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
-$as_echo "$ac_try_echo"; } >&5
-  (eval "$ac_try") 2>&5
-  ac_status=$?
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; };
-then
-  eval ac_cv_prog_cc_${ac_cc}_c_o=yes
-  if test "x$CC" != xcc; then
-    # Test first that cc exists at all.
-    if { ac_try='cc -c conftest.$ac_ext >&5'
-  { { case "(($ac_try" in
-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
-  *) ac_try_echo=$ac_try;;
-esac
-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
-$as_echo "$ac_try_echo"; } >&5
-  (eval "$ac_try") 2>&5
-  ac_status=$?
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; }; }; then
-      ac_try='cc -c conftest.$ac_ext -o conftest2.$ac_objext >&5'
-      rm -f conftest2.*
-      if { { case "(($ac_try" in
-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
-  *) ac_try_echo=$ac_try;;
-esac
-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
-$as_echo "$ac_try_echo"; } >&5
-  (eval "$ac_try") 2>&5
-  ac_status=$?
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; } &&
-	 test -f conftest2.$ac_objext && { { case "(($ac_try" in
-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
-  *) ac_try_echo=$ac_try;;
-esac
-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
-$as_echo "$ac_try_echo"; } >&5
-  (eval "$ac_try") 2>&5
-  ac_status=$?
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; };
-      then
-	# cc works too.
-	:
-      else
-	# cc exists but doesn't like -o.
-	eval ac_cv_prog_cc_${ac_cc}_c_o=no
-      fi
-    fi
-  fi
-else
-  eval ac_cv_prog_cc_${ac_cc}_c_o=no
-fi
-rm -f core conftest*
-
-fi
-if eval test \$ac_cv_prog_cc_${ac_cc}_c_o = yes; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-
-$as_echo "#define NO_MINUS_C_MINUS_O 1" >>confdefs.h
-
-fi
-
-# FIXME: we rely on the cache variable name because
-# there is no other way.
-set dummy $CC
-am_cc=`echo $2 | sed 's/[^a-zA-Z0-9_]/_/g;s/^[0-9]/_/'`
-eval am_t=\$ac_cv_prog_cc_${am_cc}_c_o
-if test "$am_t" != yes; then
-   # Losing compiler, so override with the script.
-   # FIXME: It is wrong to rewrite CC.
-   # But if we don't then we get into trouble of one sort or another.
-   # A longer-term fix would be to have automake use am__CC in this case,
-   # and then we could set am__CC="\$(top_srcdir)/compile \$(CC)"
-   CC="$am_aux_dir/compile $CC"
-fi
-
 
 # By default we simply use the C compiler to build assembly code.
 
@@ -14514,7 +14489,7 @@ cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
 # report actual input values of CONFIG_FILES etc. instead of their
 # values after options handling.
 ac_log="
-This file was extended by libGAP $as_me 4.7.5.1, which was
+This file was extended by libGAP $as_me 4.7.7, which was
 generated by GNU Autoconf 2.69.  Invocation command line was
 
   CONFIG_FILES    = $CONFIG_FILES
@@ -14580,7 +14555,7 @@ _ACEOF
 cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
 ac_cs_config="`$as_echo "$ac_configure_args" | sed 's/^ //; s/[\\""\`\$]/\\\\&/g'`"
 ac_cs_version="\\
-libGAP config.status 4.7.5.1
+libGAP config.status 4.7.7
 configured by $0, generated by GNU Autoconf 2.69,
   with options \\"\$ac_cs_config\\"
 
diff --git a/configure.ac b/configure.ac
index 0fc2f57..c85a214 100644
--- a/configure.ac
+++ b/configure.ac
@@ -1,7 +1,7 @@
 AC_PREREQ([2.66])
 
 # Note: the version number must match the GAP version number
-AC_INIT([libGAP], [4.7.5.1], [sage-devel@googlegroups.com])
+AC_INIT([libGAP], [4.7.7], [sage-devel@googlegroups.com])
 
 AC_CANONICAL_TARGET
 AM_INIT_AUTOMAKE
diff --git a/missing b/missing
index cdea514..db98974 100755
--- a/missing
+++ b/missing
@@ -1,7 +1,7 @@
 #! /bin/sh
 # Common wrapper for a few potentially missing GNU programs.
 
-scriptversion=2012-06-26.16; # UTC
+scriptversion=2013-10-28.13; # UTC
 
 # Copyright (C) 1996-2013 Free Software Foundation, Inc.
 # Originally written by Fran,cois Pinard <pinard@iro.umontreal.ca>, 1996.
@@ -160,7 +160,7 @@ give_advice ()
       ;;
    autom4te*)
       echo "You might have modified some maintainer files that require"
-      echo "the 'automa4te' program to be rebuilt."
+      echo "the 'autom4te' program to be rebuilt."
       program_details 'autom4te'
       ;;
     bison*|yacc*)
diff --git a/src/Makefile.in b/src/Makefile.in
index d31b4a1..bbc264d 100644
--- a/src/Makefile.in
+++ b/src/Makefile.in
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.13.4 from Makefile.am.
+# Makefile.in generated by automake 1.14.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994-2013 Free Software Foundation, Inc.
@@ -436,8 +436,8 @@ $(ACLOCAL_M4):  $(am__aclocal_m4_deps)
 $(am__aclocal_m4_deps):
 
 config.h: stamp-h1
-	@if test ! -f $@; then rm -f stamp-h1; else :; fi
-	@if test ! -f $@; then $(MAKE) $(AM_MAKEFLAGS) stamp-h1; else :; fi
+	@test -f $@ || rm -f stamp-h1
+	@test -f $@ || $(MAKE) $(AM_MAKEFLAGS) stamp-h1
 
 stamp-h1: $(srcdir)/config.h.in $(top_builddir)/config.status
 	@rm -f stamp-h1
@@ -564,14 +564,14 @@ distclean-compile:
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c $<
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c -o $@ $<
 
 .c.obj:
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c `$(CYGPATH_W) '$<'`
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
 
 .c.lo:
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(LTCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
diff --git a/src/compiled.h b/src/compiled.h
index 4593946..befcbb7 100644
--- a/src/compiled.h
+++ b/src/compiled.h
@@ -9,6 +9,11 @@
 #ifndef GAP_COMPILED_H
 #define GAP_COMPILED_H
 
+#ifdef __cplusplus
+extern "C" {
+#define GAP_IN_EXTERN_C
+#endif
+
 #include        "system.h"              /* system dependent part           */
 
 #include        "gasman.h"              /* garbage collector               */
@@ -456,6 +461,11 @@ static inline Obj C_NORMALIZE_64BIT( Obj o) {
 
 #endif
 
+#ifdef __cplusplus
+}
+#undef GAP_IN_EXTERN_C
+#endif
+    
 #endif // GAP_COMPILED_H
 
 /****************************************************************************
diff --git a/src/config.h.in b/src/config.h.in
index d198ce0..7fcb02a 100644
--- a/src/config.h.in
+++ b/src/config.h.in
@@ -379,9 +379,6 @@
    <sysmacros.h>. */
 #undef MAJOR_IN_SYSMACROS
 
-/* Define to 1 if your C compiler doesn't accept -c and -o together. */
-#undef NO_MINUS_C_MINUS_O
-
 /* Name of package */
 #undef PACKAGE
 
diff --git a/src/gap.c b/src/gap.c
index fe33f7a..8f536d2 100644
--- a/src/gap.c
+++ b/src/gap.c
@@ -786,6 +786,7 @@ int gap_main_loop (
   NrImportedFuncs = 0;
   ErrorHandler = (Obj) 0;
   UserHasQUIT = 0;
+  UserHasQUITReturnValue = 0;
   UserHasQuit = 0;
     
   /* initialize everything and read init.g which runs the GAP session */
@@ -1386,7 +1387,8 @@ Obj FuncJUMP_TO_CATCH( Obj self, Obj payload)
   
 
 UInt UserHasQuit;
-UInt UserHasQUIT; 
+UInt UserHasQUIT;
+UInt UserHasQUITReturnValue;
 
 Obj FuncSetUserHasQuit( Obj Self, Obj value)
 {
@@ -2700,9 +2702,20 @@ Obj FuncSleep( Obj self, Obj secs )
 **
 */
 
-Obj FuncQUIT_GAP( Obj self )
+Obj FuncQUIT_GAP( Obj self, Obj args )
 {
+  if ( LEN_LIST(args) == 0 ) {
+    UserHasQUITReturnValue = 0;
+  }
+  else if ( LEN_LIST(args) == 1 && IS_INTOBJ( ELM_PLIST(args,1) ) ) {
+    UserHasQUITReturnValue = INT_INTOBJ( ELM_PLIST( args, 1 ) );
+  }
+  else {
+    ErrorQuit( "usage: QUIT_GAP( [ <return value> ] )", 0L, 0L );
+    return 0;
+  }
   UserHasQUIT = 1;
+  
   ReadEvalError();
   return (Obj)0; 
 }
@@ -2903,7 +2916,7 @@ static StructGVarFunc GVarFuncs [] = {
     { "Sleep", 1, "secs",
       FuncSleep, "src/gap.c:Sleep" },
 
-    { "QUIT_GAP", 0, "",
+    { "QUIT_GAP", -1, "args",
       FuncQUIT_GAP, "src/gap.c:QUIT_GAP" },
 
 
diff --git a/src/gap.h b/src/gap.h
index d8a1c0e..b2272e9 100644
--- a/src/gap.h
+++ b/src/gap.h
@@ -229,6 +229,7 @@ typedef UInt ExecStatus;
 
 extern UInt UserHasQuit;
 extern UInt UserHasQUIT;
+extern UInt UserHasQUITReturnValue;
 
 #if 0
 /****************************************************************************
diff --git a/src/gasman.c b/src/gasman.c
index 0dd65d5..4441188 100644
--- a/src/gasman.c
+++ b/src/gasman.c
@@ -285,6 +285,39 @@ UInt                    AllocSizeBags;
 Bag *                   StopBags;
 Bag *                   EndBags;
 
+#ifdef MEMORY_CANARY
+
+#include <valgrind/valgrind.h>
+#include <valgrind/memcheck.h>
+Int canary_size() {
+  Int bufsize = (Int)StopBags - (Int)AllocBags;
+  return bufsize<4096?bufsize:4096;
+}
+
+void ADD_CANARY() {
+  VALGRIND_MAKE_MEM_NOACCESS(AllocBags, canary_size());
+}
+void CLEAR_CANARY() {
+  VALGRIND_MAKE_MEM_DEFINED(AllocBags, canary_size());
+}
+#define CANARY_DISABLE_VALGRIND()  VALGRIND_DISABLE_ERROR_REPORTING
+#define CANARY_ENABLE_VALGRIND() VALGRIND_ENABLE_ERROR_REPORTING
+
+void CHANGED_BAG_IMPL(Bag bag) {
+    CANARY_DISABLE_VALGRIND();
+    if ( PTR_BAG(bag) <= YoungBags && PTR_BAG(bag)[-1] == (bag) ) {                          
+        PTR_BAG(bag)[-1] = ChangedBags;
+        ChangedBags = (bag);    
+    }
+    CANARY_ENABLE_VALGRIND();
+}
+#else
+#define ADD_CANARY()
+#define CLEAR_CANARY()
+#define CANARY_DISABLE_VALGRIND()
+#define CANARY_ENABLE_VALGRIND()
+#endif
+
 
 /* These macros, are (a) for more readable code, but more importantly
    (b) to ensure that unsigned subtracts and divides are used (since
@@ -1137,11 +1170,11 @@ Bag NewBag (
     /* get the identifier of the bag and set 'FreeMptrBags' to the next    */
     bag          = FreeMptrBags;
     FreeMptrBags = *(Bag*)bag;
-
+    CLEAR_CANARY();
     /* allocate the storage for the bag                                    */
     dst       = AllocBags;
     AllocBags = dst + HEADER_SIZE + WORDS_BAG(size);
-
+    ADD_CANARY();
 
     /* enter size-type words                                               */
 #ifdef USE_NEWSHAPE
@@ -1360,7 +1393,7 @@ void            RetypeBag (
 
     /* if the last bag is to be enlarged                                   */
     else if ( PTR_BAG(bag) + WORDS_BAG(old_size) == AllocBags ) {
-
+        CLEAR_CANARY();
         /* check that enough storage for the new bag is available          */
         if ( StopBags < PTR_BAG(bag)+WORDS_BAG(new_size)
           && CollectBags( new_size-old_size, 0 ) == 0 ) {
@@ -1372,6 +1405,7 @@ void            RetypeBag (
             YoungBags += WORDS_BAG(new_size) - WORDS_BAG(old_size);
         AllocBags += WORDS_BAG(new_size) - WORDS_BAG(old_size);
 
+        ADD_CANARY();
         /* change the size-type word                                       */
 #ifdef USE_NEWSHAPE
       *(*bag-2) = (new_size << 16 | type);
@@ -1388,11 +1422,11 @@ void            RetypeBag (
           && CollectBags( new_size, 0 ) == 0 ) {
             return 0;
         }
-
+        CLEAR_CANARY();
         /* allocate the storage for the bag                                */
         dst       = AllocBags;
         AllocBags = dst + HEADER_SIZE + WORDS_BAG(new_size);
-        
+        ADD_CANARY();
         /* leave magic size-type word  for the sweeper, type must be 255   */
 #ifdef USE_NEWSHAPE
         *(*bag-2) = (((WORDS_BAG(old_size)+1) * sizeof(Bag))) << 16 | 255;
@@ -1407,12 +1441,13 @@ void            RetypeBag (
         *dst++ = (Bag)new_size;
 #endif
         
-
+        CANARY_DISABLE_VALGRIND();
         /* if the bag is already on the changed bags list, keep it there   */
         if ( PTR_BAG(bag)[-1] != bag ) {
             *dst++ = PTR_BAG(bag)[-1];
         }
 
+
         /* if the bag is old, put it onto the changed bags list            */
         else if ( PTR_BAG(bag) <= YoungBags ) {
             *dst++ = ChangedBags;  ChangedBags = bag;
@@ -1422,6 +1457,7 @@ void            RetypeBag (
         else {
             *dst++ = bag;
         }
+	CANARY_ENABLE_VALGRIND();
 
         /* set the masterpointer                                           */
         src = PTR_BAG(bag);
@@ -1722,6 +1758,8 @@ UInt CollectBags (
     /*     Bag *               last;
            Char                type; */
 
+    CANARY_DISABLE_VALGRIND();
+    CLEAR_CANARY();
 #ifdef DEBUG_MASTERPOINTERS
     CheckMasterPointers();
 #endif
@@ -2293,6 +2331,8 @@ again:
     /* Possibly advise the operating system about unused pages:            */
     SyMAdviseFree();
 
+    CANARY_ENABLE_VALGRIND();
+
     /* return success                                                      */
     return 1;
 }
diff --git a/src/gasman.h b/src/gasman.h
index 999df4d..e9b71fc 100644
--- a/src/gasman.h
+++ b/src/gasman.h
@@ -251,11 +251,27 @@ extern  Bag *                   YoungBags;
 
 extern  Bag                     ChangedBags;
 
+/*****
+**  MEMORY_CANARY provides (basic) support for catching out-of-bounds memory
+**  problems in GAP. This is done through the excellent 'valgrind' program.
+**  valgrind is of limited use in GAP normally, because it doesn't understand
+**  GAP's memory manager. Enabling MEMORY_CANARY will make an executable where
+**  valgrind will detect memory issues.
+**
+**  At the moment the detection is limited to only writing off the last allocated
+**  block.
+*/
+
+#ifdef MEMORY_CANARY
+extern void CHANGED_BAG_IMPL(Bag b);
+#define CHANGED_BAG(bag) CHANGED_BAG_IMPL(bag);
+#else
 #define CHANGED_BAG(bag)                                                    \
                 if (   PTR_BAG(bag) <= YoungBags                              \
                   && PTR_BAG(bag)[-1] == (bag) ) {                          \
                     PTR_BAG(bag)[-1] = ChangedBags; ChangedBags = (bag);    }
 
+#endif
 
 /****************************************************************************
 **
diff --git a/src/gmpints.c b/src/gmpints.c
index bd9c66b..09dc128 100644
--- a/src/gmpints.c
+++ b/src/gmpints.c
@@ -57,7 +57,14 @@
 
 #ifdef USE_GMP
 
+// GMP must be included outside of 'extern C'
+#ifdef GAP_IN_EXTERN_C
+}
+#endif
 #include <gmp.h>
+#ifdef GAP_IN_EXTERN_C
+extern "C" {
+#endif
 
 #include        "gmpints.h"             /* GMP integers                    */
 
@@ -521,7 +528,7 @@ Obj FuncIntHexString( Obj self,  Obj str )
 
   len = GET_LEN_STRING(str);
   if (len == 0) {
-    res = INT_INTOBJ(0);
+    res = INTOBJ_INT(0);
     return res;
   }
   if (*(CHARS_STRING(str)) == '-') {
@@ -2037,8 +2044,8 @@ Obj RemInt ( Obj opL, Obj opR )
     }
     
     /* maybe it's trivial                                                   */
-    if ( INTBASE % abs(INT_INTOBJ(opR)) == 0 ) {
-      c = ADDR_INT(opL)[0] % abs(INT_INTOBJ(opR));
+    if ( INTBASE % INT_INTOBJ(AbsInt(opR)) == 0 ) {
+      c = ADDR_INT(opL)[0] % INT_INTOBJ(AbsInt(opR));
     }
     
     /* otherwise run through the left operand and divide digitwise         */
diff --git a/src/gmpints.h b/src/gmpints.h
index 93b292c..f849ff8 100644
--- a/src/gmpints.h
+++ b/src/gmpints.h
@@ -17,7 +17,14 @@
 
 #ifdef USE_GMP
 
+// GMP must be included outside of 'extern C'
+#ifdef GAP_IN_EXTERN_C
+}
+#endif
 #include <gmp.h>
+#ifdef GAP_IN_EXTERN_C
+extern "C" {
+#endif
 
 /****************************************************************************
 **
diff --git a/src/integer.c b/src/integer.c
index 1d74994..3fef904 100644
--- a/src/integer.c
+++ b/src/integer.c
@@ -119,31 +119,6 @@
 /* for fallbacks to library */
 Obj String;
 
-/****************************************************************************
-**
-
-*T  TypDigit  . . . . . . . . . . . . . . . . . . . .  type of a single digit
-**
-**  'TypDigit' is the type of a single digit of an  arbitrary  size  integer.
-**  This is of course unsigned short int, which gives us the 16 bits we want.
-**
-**  'TypDigit' is defined in the declaration file of the package as follows:
-**
-#ifdef SYS_IS_64_BIT
-typedef UInt4           TypDigit;
-#else
-typedef UInt2           TypDigit;
-#endif
-#define NR_DIGIT_BITS      (8 * sizeof(TypDigit))
-#define INTBASE            (1L << NR_DIGIT_BITS)
-#define NR_SMALL_INT_BITS  (2*NR_DIGIT_BITS - 4)
-#define SIZE_INT(op)    (SIZE_OBJ(op) / sizeof(TypDigit))
-#define ADDR_INT(op)    ((TypDigit*)ADDR_OBJ(op))
-*/
-
-
-
-
 
 /****************************************************************************
 **
@@ -397,7 +372,7 @@ Obj  FuncIntHexString( Obj self,  Obj str )
     /* number of hex digits and sign */
     len = GET_LEN_STRING(str);
     if (len == 0) {
-       res = INT_INTOBJ(0);
+       res = INTOBJ_INT(0);
        return res;
     }
     if (*(CHARS_STRING(str)) == '-') {
diff --git a/src/integer.h b/src/integer.h
index 368e97a..fa53cf6 100644
--- a/src/integer.h
+++ b/src/integer.h
@@ -39,7 +39,7 @@ typedef UInt2           TypDigit;
 #endif
 
 #define NR_DIGIT_BITS      (8 * sizeof(TypDigit))
-#define INTBASE            (1L << NR_DIGIT_BITS)
+#define INTBASE            (1UL << NR_DIGIT_BITS)
 #define NR_SMALL_INT_BITS  (2*NR_DIGIT_BITS - 4)
 #define SIZE_INT(op)    (SIZE_OBJ(op) / sizeof(TypDigit))
 #define ADDR_INT(op)    ((TypDigit*)ADDR_OBJ(op))
diff --git a/src/intfuncs.c b/src/intfuncs.c
index 7232920..1aa973e 100644
--- a/src/intfuncs.c
+++ b/src/intfuncs.c
@@ -273,7 +273,7 @@ integrate with GAP  SL*/
 // Platform-specific functions and macros
 
 
-#define FORCE_INLINE inline
+#define FORCE_INLINE static inline
 
 static inline uint32_t rotl32 ( uint32_t x, int8_t r )
 {
diff --git a/src/objfgelm.h b/src/objfgelm.h
index 4d82c08..5893f6c 100644
--- a/src/objfgelm.h
+++ b/src/objfgelm.h
@@ -123,20 +123,28 @@
 **  <npairs> pairs of generator number/exponent.  The new  word is return  in
 **  <word>.
 */
-#define NEW_WORD( word, kind, npairs ) \
- ((word)=NewBag(T_DATOBJ,2*sizeof(Obj)+((npairs)*BITS_WORDTYPE((kind))/8L)),\
-  (ADDR_OBJ((word))[1] = INTOBJ_INT((npairs))),\
-  SET_TYPE_DATOBJ( (word), (kind) ), (word) )
+static inline Obj NewWord(Obj kind, UInt npairs) {
+  Obj word;
+  word = NewBag(T_DATOBJ,2*sizeof(Obj)+npairs*BITS_WORDTYPE(kind)/8L);
+  (ADDR_OBJ(word)[1] = INTOBJ_INT(npairs));
+  SET_TYPE_DATOBJ( word, kind);
+  return word;
+}
+
+#define NEW_WORD(word, kind, npairs) \
+  (word) = NewWord((kind), (npairs));
 
 
 /****************************************************************************
 **
 *F  RESIZE_WORD( <word>, <npairs> )
 */
-#define RESIZE_WORD( word, bits, npairs ) \
-  (ResizeBag( (word), 2*sizeof(Obj)+((npairs)*BITS_WORD((word))/8L)), \
-   (ADDR_OBJ((word))[1] = INTOBJ_INT((npairs))), \
-   (word) )
+static inline Obj RESIZE_WORD( Obj word, UInt npairs )
+{
+  ResizeBag( (word), 2*sizeof(Obj)+((npairs)*BITS_WORD((word))/8L));
+  (ADDR_OBJ((word))[1] = INTOBJ_INT((npairs)));
+  return word;
+}
 
 
 /****************************************************************************
diff --git a/src/objscoll.c b/src/objscoll.c
index c5fcff8..c5c823e 100644
--- a/src/objscoll.c
+++ b/src/objscoll.c
@@ -123,7 +123,7 @@ Obj C8Bits_WordVectorAndClear ( Obj kind, Obj vv, Int num )
     }
 
     /* correct the size of <obj>                                           */
-    RESIZE_WORD( obj, 8L, j );
+    RESIZE_WORD( obj, j );
     return obj;
 }
 
@@ -703,7 +703,7 @@ Obj C16Bits_WordVectorAndClear ( Obj kind, Obj vv, Int num )
     }
 
     /* correct the size of <obj>                                           */
-    RESIZE_WORD( obj, 16L, j );
+    RESIZE_WORD( obj, j );
     return obj;
 }
 
@@ -1285,7 +1285,7 @@ Obj C32Bits_WordVectorAndClear ( Obj kind, Obj vv, Int num )
     }
 
     /* correct the size of <obj>                                           */
-    RESIZE_WORD( obj, 32L, j );
+    RESIZE_WORD( obj, j );
     return obj;
 }
 
diff --git a/src/opers.c b/src/opers.c
index 34585f4..2606aac 100644
--- a/src/opers.c
+++ b/src/opers.c
@@ -2859,8 +2859,8 @@ Obj NewOperation (
       HDLR_FUNC(oper,narg) = hdlr;
 
     /*N 1996/06/06 mschoene this should not be done here                   */
-    FLAG1_FILT(oper) = INT_INTOBJ(0);
-    FLAG2_FILT(oper) = INT_INTOBJ(0);
+    FLAG1_FILT(oper) = INTOBJ_INT(0);
+    FLAG2_FILT(oper) = INTOBJ_INT(0);
     FLAGS_FILT(oper) = False;
     SETTR_FILT(oper) = False;
     TESTR_FILT(oper) = False;
@@ -4295,8 +4295,8 @@ Obj NewConstructor (
     }
 
     /*N 1996/06/06 mschoene this should not be done here                   */
-    FLAG1_FILT(oper) = INT_INTOBJ(0);
-    FLAG2_FILT(oper) = INT_INTOBJ(0);
+    FLAG1_FILT(oper) = INTOBJ_INT(0);
+    FLAG2_FILT(oper) = INTOBJ_INT(0);
     FLAGS_FILT(oper) = False;
     SETTR_FILT(oper) = False;
     TESTR_FILT(oper) = False;
diff --git a/src/pperm.c b/src/pperm.c
index 0d97cb7..9f2955a 100644
--- a/src/pperm.c
+++ b/src/pperm.c
@@ -1807,7 +1807,7 @@ Obj FuncRESTRICTED_PPERM(Obj self, Obj f, Obj set){
     ptf2=ADDR_PPERM2(f);
     
     // find pos in list corresponding to degree of new pperm
-    while(n>0&&INT_INTOBJ(ELM_LIST(set, n))>deg) n--;
+    while(n>0&&(UInt) INT_INTOBJ(ELM_LIST(set, n))>deg) n--;
     while(n>0&&ptf2[INT_INTOBJ(ELM_LIST(set, n))-1]==0) n--;
     if(n==0) return EmptyPartialPerm;
 
@@ -1826,7 +1826,7 @@ Obj FuncRESTRICTED_PPERM(Obj self, Obj f, Obj set){
     deg=DEG_PPERM4(f);
     ptf4=ADDR_PPERM4(f);
     
-    while(n>0&&INT_INTOBJ(ELM_LIST(set, n))>deg) n--;
+    while(n>0&&(UInt) INT_INTOBJ(ELM_LIST(set, n))>deg) n--;
     while(n>0&&ptf4[INT_INTOBJ(ELM_LIST(set, n))-1]==0) n--;
     if(n==0) return EmptyPartialPerm;
    
@@ -2516,9 +2516,7 @@ Obj ProdPPerm22(Obj f, Obj g){
     rank=RANK_PPERM2(f);
     for(i=1;i<=rank;i++){
       j=INT_INTOBJ(ELM_PLIST(dom, i))-1;
-      //JDM could have additional case so that we don't have to check
-      //ptf[i]<=degg
-      if(ptf[j]<=degg){ 
+      if(j<deg && ptf[j]<=degg){ 
         ptfg[j]=ptg[ptf[j]-1];
         if(ptfg[j]>codeg) codeg=ptfg[j];
       }
@@ -2568,7 +2566,7 @@ Obj ProdPPerm42(Obj f, Obj g){
     rank=RANK_PPERM4(f);
     for(i=1;i<=rank;i++){
       j=INT_INTOBJ(ELM_PLIST(dom, i))-1;
-      if(ptf[j]<=degg){ 
+      if(j<deg && ptf[j]<=degg){ 
         ptfg[j]=ptg[ptf[j]-1];
         if(ptfg[j]>codeg) codeg=ptfg[j];
       }
@@ -2592,44 +2590,56 @@ Obj ProdPPerm44(Obj f, Obj g){
   UInt4   *ptf, *ptg, *ptfg;
   Obj     fg, dom;
 
-  if(DEG_PPERM4(g)==0) return EmptyPartialPerm;
+  if (DEG_PPERM4(g) == 0) { 
+    return EmptyPartialPerm;
+  }
 
   // find the degree
-  deg=DEG_PPERM4(f);
-  degg=DEG_PPERM4(g);
-  ptf=ADDR_PPERM4(f);
-  ptg=ADDR_PPERM4(g);
-  while(deg>0&&(ptf[deg-1]==0||ptf[deg-1]>degg||ptg[ptf[deg-1]-1]==0)) deg--;
-  if(deg==0) return EmptyPartialPerm;
+  deg = DEG_PPERM4(f);
+  degg = DEG_PPERM4(g);
+  ptf = ADDR_PPERM4(f);
+  ptg = ADDR_PPERM4(g);
+  while (deg > 0 
+      && (ptf[deg - 1] == 0 || ptf[deg - 1] > degg || ptg[ptf[deg - 1] - 1] == 0)){
+    deg--;
+  }
+  
+  if(deg == 0){
+    return EmptyPartialPerm;
+  }
   
   // create new pperm
-  fg=NEW_PPERM4(deg);
-  ptfg=ADDR_PPERM4(fg);
-  ptf=ADDR_PPERM4(f);
-  ptg=ADDR_PPERM4(g);
-  codeg=0;
+  fg = NEW_PPERM4(deg);
+  ptfg = ADDR_PPERM4(fg);
+  ptf = ADDR_PPERM4(f);
+  ptg = ADDR_PPERM4(g);
+  codeg = 0;
  
   // compose in rank operations
-  if(DOM_PPERM(f)!=NULL){
-    dom=DOM_PPERM(f); 
-    rank=RANK_PPERM4(f);
-    for(i=1;i<=rank;i++){
-      j=INT_INTOBJ(ELM_PLIST(dom, i))-1;
-      if(ptf[j]<=degg){ 
-        ptfg[j]=ptg[ptf[j]-1];
-        if(ptfg[j]>codeg) codeg=ptfg[j];
+  if (DOM_PPERM(f) != NULL) {
+    dom = DOM_PPERM(f); 
+    rank = RANK_PPERM4(f);
+    for (i = 1; i <= rank; i++) {
+      j = INT_INTOBJ(ELM_PLIST(dom, i)) - 1;
+      if (j < deg && ptf[j] <= degg) { 
+        ptfg[j] = ptg[ptf[j] - 1];
+        if(ptfg[j] > codeg){
+          codeg = ptfg[j];
+        }
       }
     }
   } else { 
   // compose in deg operations
-    for(i=0;i<deg;i++){
-      if(ptf[i]!=0&&ptf[i]<=degg){
-        ptfg[i]=ptg[ptf[i]-1];
-        if(ptfg[i]>codeg) codeg=ptfg[i];
+    for (i = 0; i < deg; i++) {
+      if (ptf[i] != 0 && ptf[i] <= degg) {
+        ptfg[i] = ptg[ptf[i] - 1];
+        if (ptfg[i] > codeg) {
+          codeg = ptfg[i];
+        }
       }
     }
   }
-  CODEG_PPERM4(fg)=codeg;
+  CODEG_PPERM4(fg) = codeg;
   return fg;
 }
 
@@ -2669,7 +2679,7 @@ Obj ProdPPerm24(Obj f, Obj g){
     rank=RANK_PPERM2(f);
     for(i=1;i<=rank;i++){
       j=INT_INTOBJ(ELM_PLIST(dom, i))-1;
-      if(ptf[j]<=degg){ 
+      if(j<deg && ptf[j]<=degg){ 
         ptfg[j]=ptg[ptf[j]-1];
         if(ptfg[j]>codeg) codeg=ptfg[j];
       }
@@ -3363,8 +3373,10 @@ Obj PowPPerm22( Obj f, Obj g ){
       for(i=0;i<min;i++){
         if(ptf[i]!=0&&ptg[i]!=0){
           img=ptg[ptf[i]-1];
-          ptconj[ptg[i]-1]=img;
-          if(img>codec) codec=img;
+          if(img!=0){
+            ptconj[ptg[i]-1]=img;
+            if(img>codec) codec=img;
+          }
         }
       }
     } else { //codeg(f)>deg(g)
@@ -3388,8 +3400,10 @@ Obj PowPPerm22( Obj f, Obj g ){
       for(i=0;i<min;i++){
         if(ptf[i]!=0&&ptg[i]!=0){
           img=IMAGEPP(ptf[i], ptg, deg);
-          ptconj[ptg[i]-1]=img;
-          if(img>codec) codec=img;
+          if(img!=0){
+            ptconj[ptg[i]-1]=img;
+            if(img>codec) codec=img;
+          }
         }
       }
     }
@@ -3416,8 +3430,10 @@ Obj PowPPerm22( Obj f, Obj g ){
         j=INT_INTOBJ(ELM_PLIST(dom, i))-1;
         if(IMAGEPP(j+1, ptg, deg)!=0){
           img=ptg[ptf[j]-1];
-          ptconj[ptg[j]-1]=img;
-          if(img>codec) codec=img;
+          if(img!=0){
+            ptconj[ptg[j]-1]=img;
+            if(img>codec) codec=img;
+          }
         }
       }
     } else { //codeg(f)>deg(g)
@@ -3442,8 +3458,10 @@ Obj PowPPerm22( Obj f, Obj g ){
         j=INT_INTOBJ(ELM_PLIST(dom, i))-1;
         if(IMAGEPP(j+1, ptg, deg)!=0){
           img=IMAGEPP(ptf[j], ptg, deg);
-          ptconj[ptg[j]-1]=img;
-          if(img>codec) codec=img;
+          if(img!=0){
+            ptconj[ptg[j]-1]=img;
+            if(img>codec) codec=img;
+          }
         }
       }
     }
@@ -3470,8 +3488,10 @@ Obj PowPPerm22( Obj f, Obj g ){
         j=INT_INTOBJ(ELM_PLIST(dom, i))-1;
         if(ptg[j]!=0){
           img=ptg[ptf[j]-1];
-          ptconj[ptg[j]-1]=img;
-          if(img>codec) codec=img;
+          if(img!=0){
+            ptconj[ptg[j]-1]=img;
+            if(img>codec) codec=img;
+          }
         }
       }
     } else {//codeg(f)>deg(g)
@@ -3496,8 +3516,10 @@ Obj PowPPerm22( Obj f, Obj g ){
         j=INT_INTOBJ(ELM_PLIST(dom, i))-1;
         if(ptg[j]!=0){
           img=IMAGEPP(ptf[j], ptg, deg);
-          ptconj[ptg[j]-1]=img;
-          if(img>codec) codec=img;
+          if(img!=0){
+            ptconj[ptg[j]-1]=img;
+            if(img>codec) codec=img;
+          }
         }
       }
     }
@@ -3547,8 +3569,10 @@ Obj PowPPerm24( Obj f, Obj g ){
       for(i=0;i<min;i++){
         if(ptf[i]!=0&&ptg[i]!=0){
           img=ptg[ptf[i]-1];
-          ptconj[ptg[i]-1]=img;
-          if(img>codec) codec=img;
+          if(img!=0){
+            ptconj[ptg[i]-1]=img;
+            if(img>codec) codec=img;
+          }
         }
       }
     } else { //codeg(f)>deg(g)
@@ -3572,8 +3596,10 @@ Obj PowPPerm24( Obj f, Obj g ){
       for(i=0;i<min;i++){
         if(ptf[i]!=0&&ptg[i]!=0){
           img=IMAGEPP(ptf[i], ptg, deg);
-          ptconj[ptg[i]-1]=img;
-          if(img>codec) codec=img;
+          if(img!=0){
+            ptconj[ptg[i]-1]=img;
+            if(img>codec) codec=img;
+          }
         }
       }
     }
@@ -3600,8 +3626,10 @@ Obj PowPPerm24( Obj f, Obj g ){
         j=INT_INTOBJ(ELM_PLIST(dom, i))-1;
         if(IMAGEPP(j+1, ptg, deg)!=0){
           img=ptg[ptf[j]-1];
-          ptconj[ptg[j]-1]=img;
-          if(img>codec) codec=img;
+          if(img!=0){
+            ptconj[ptg[j]-1]=img;
+            if(img>codec) codec=img;
+          }
         }
       }
     } else { //codeg(f)>deg(g)
@@ -3626,8 +3654,10 @@ Obj PowPPerm24( Obj f, Obj g ){
         j=INT_INTOBJ(ELM_PLIST(dom, i))-1;
         if(IMAGEPP(j+1, ptg, deg)!=0){
           img=IMAGEPP(ptf[j], ptg, deg);
-          ptconj[ptg[j]-1]=img;
-          if(img>codec) codec=img;
+          if(img!=0){
+            ptconj[ptg[j]-1]=img;
+            if(img>codec) codec=img;
+          }
         }
       }
     }
@@ -3654,8 +3684,10 @@ Obj PowPPerm24( Obj f, Obj g ){
         j=INT_INTOBJ(ELM_PLIST(dom, i))-1;
         if(ptg[j]!=0){
           img=ptg[ptf[j]-1];
-          ptconj[ptg[j]-1]=img;
-          if(img>codec) codec=img;
+          if(img!=0){
+            ptconj[ptg[j]-1]=img;
+            if(img>codec) codec=img;
+          }
         }
       }
     } else {//codeg(f)>deg(g)
@@ -3680,8 +3712,10 @@ Obj PowPPerm24( Obj f, Obj g ){
         j=INT_INTOBJ(ELM_PLIST(dom, i))-1;
         if(ptg[j]!=0){
           img=IMAGEPP(ptf[j], ptg, deg);
-          ptconj[ptg[j]-1]=img;
-          if(img>codec) codec=img;
+          if(img!=0){
+            ptconj[ptg[j]-1]=img;
+            if(img>codec) codec=img;
+          }
         }
       }
     }
@@ -3731,8 +3765,10 @@ Obj PowPPerm42( Obj f, Obj g ){
       for(i=0;i<min;i++){
         if(ptf[i]!=0&&ptg[i]!=0){
           img=ptg[ptf[i]-1];
-          ptconj[ptg[i]-1]=img;
-          if(img>codec) codec=img;
+          if(img!=0){
+            ptconj[ptg[i]-1]=img;
+            if(img>codec) codec=img;
+          }
         }
       }
     } else { //codeg(f)>deg(g)
@@ -3756,8 +3792,10 @@ Obj PowPPerm42( Obj f, Obj g ){
       for(i=0;i<min;i++){
         if(ptf[i]!=0&&ptg[i]!=0){
           img=IMAGEPP(ptf[i], ptg, deg);
-          ptconj[ptg[i]-1]=img;
-          if(img>codec) codec=img;
+          if(img!=0){
+            ptconj[ptg[i]-1]=img;
+            if(img>codec) codec=img;
+          }
         }
       }
     }
@@ -3784,8 +3822,10 @@ Obj PowPPerm42( Obj f, Obj g ){
         j=INT_INTOBJ(ELM_PLIST(dom, i))-1;
         if(IMAGEPP(j+1, ptg, deg)!=0){
           img=ptg[ptf[j]-1];
-          ptconj[ptg[j]-1]=img;
-          if(img>codec) codec=img;
+          if(img!=0){
+            ptconj[ptg[j]-1]=img;
+            if(img>codec) codec=img;
+          }
         }
       }
     } else { //codeg(f)>deg(g)
@@ -3810,8 +3850,10 @@ Obj PowPPerm42( Obj f, Obj g ){
         j=INT_INTOBJ(ELM_PLIST(dom, i))-1;
         if(IMAGEPP(j+1, ptg, deg)!=0){
           img=IMAGEPP(ptf[j], ptg, deg);
-          ptconj[ptg[j]-1]=img;
-          if(img>codec) codec=img;
+          if(img!=0){
+            ptconj[ptg[j]-1]=img;
+            if(img>codec) codec=img;
+          }
         }
       }
     }
@@ -3838,8 +3880,10 @@ Obj PowPPerm42( Obj f, Obj g ){
         j=INT_INTOBJ(ELM_PLIST(dom, i))-1;
         if(ptg[j]!=0){
           img=ptg[ptf[j]-1];
-          ptconj[ptg[j]-1]=img;
-          if(img>codec) codec=img;
+          if(img!=0){
+            ptconj[ptg[j]-1]=img;
+            if(img>codec) codec=img;
+          }
         }
       }
     } else {//codeg(f)>deg(g)
@@ -3864,8 +3908,10 @@ Obj PowPPerm42( Obj f, Obj g ){
         j=INT_INTOBJ(ELM_PLIST(dom, i))-1;
         if(ptg[j]!=0){
           img=IMAGEPP(ptf[j], ptg, deg);
-          ptconj[ptg[j]-1]=img;
-          if(img>codec) codec=img;
+          if(img!=0){
+            ptconj[ptg[j]-1]=img;
+            if(img>codec) codec=img;
+          }
         }
       }
     }
@@ -3914,8 +3960,10 @@ Obj PowPPerm44( Obj f, Obj g ){
       for(i=0;i<min;i++){
         if(ptf[i]!=0&&ptg[i]!=0){
           img=ptg[ptf[i]-1];
-          ptconj[ptg[i]-1]=img;
-          if(img>codec) codec=img;
+          if(img!=0){
+            ptconj[ptg[i]-1]=img;
+            if(img>codec) codec=img;
+          }
         }
       }
     } else { //codeg(f)>deg(g)
@@ -3939,8 +3987,10 @@ Obj PowPPerm44( Obj f, Obj g ){
       for(i=0;i<min;i++){
         if(ptf[i]!=0&&ptg[i]!=0){
           img=IMAGEPP(ptf[i], ptg, deg);
-          ptconj[ptg[i]-1]=img;
-          if(img>codec) codec=img;
+          if(img!=0){
+            ptconj[ptg[i]-1]=img;
+            if(img>codec) codec=img;
+          }
         }
       }
     }
@@ -3967,8 +4017,10 @@ Obj PowPPerm44( Obj f, Obj g ){
         j=INT_INTOBJ(ELM_PLIST(dom, i))-1;
         if(IMAGEPP(j+1, ptg, deg)!=0){
           img=ptg[ptf[j]-1];
-          ptconj[ptg[j]-1]=img;
-          if(img>codec) codec=img;
+          if(img!=0){
+            ptconj[ptg[j]-1]=img;
+            if(img>codec) codec=img;
+          }
         }
       }
     } else { //codeg(f)>deg(g)
@@ -3993,8 +4045,10 @@ Obj PowPPerm44( Obj f, Obj g ){
         j=INT_INTOBJ(ELM_PLIST(dom, i))-1;
         if(IMAGEPP(j+1, ptg, deg)!=0){
           img=IMAGEPP(ptf[j], ptg, deg);
-          ptconj[ptg[j]-1]=img;
-          if(img>codec) codec=img;
+          if(img!=0){
+            ptconj[ptg[j]-1]=img;
+            if(img>codec) codec=img;
+          }
         }
       }
     }
@@ -4021,8 +4075,10 @@ Obj PowPPerm44( Obj f, Obj g ){
         j=INT_INTOBJ(ELM_PLIST(dom, i))-1;
         if(ptg[j]!=0){
           img=ptg[ptf[j]-1];
-          ptconj[ptg[j]-1]=img;
-          if(img>codec) codec=img;
+          if(img!=0){
+            ptconj[ptg[j]-1]=img;
+            if(img>codec) codec=img;
+          }
         }
       }
     } else {//codeg(f)>deg(g)
@@ -4047,8 +4103,10 @@ Obj PowPPerm44( Obj f, Obj g ){
         j=INT_INTOBJ(ELM_PLIST(dom, i))-1;
         if(ptg[j]!=0){
           img=IMAGEPP(ptf[j], ptg, deg);
-          ptconj[ptg[j]-1]=img;
-          if(img>codec) codec=img;
+          if(img!=0){
+            ptconj[ptg[j]-1]=img;
+            if(img>codec) codec=img;
+          }
         }
       }
     }
@@ -4611,7 +4669,7 @@ Obj PowIntPPerm2(Obj i, Obj f){
     ErrorQuit("usage: the first argument should be a positive integer,", 0L, 0L);
     return 0L;
   }
-  return INTOBJ_INT(IMAGEPP(INT_INTOBJ(i), ADDR_PPERM2(f), DEG_PPERM2(f)));
+  return INTOBJ_INT(IMAGEPP((UInt) INT_INTOBJ(i), ADDR_PPERM2(f), DEG_PPERM2(f)));
 }
 
 Obj PowIntPPerm4(Obj i, Obj f){
@@ -4620,7 +4678,7 @@ Obj PowIntPPerm4(Obj i, Obj f){
     ErrorQuit("usage: the first argument should be a positive integer,", 0L, 0L);
     return 0L;
   }
-  return INTOBJ_INT(IMAGEPP(INT_INTOBJ(i), ADDR_PPERM4(f), DEG_PPERM4(f)));
+  return INTOBJ_INT(IMAGEPP((UInt) INT_INTOBJ(i), ADDR_PPERM4(f), DEG_PPERM4(f)));
 }
 
 // p^-1*f
@@ -5905,7 +5963,9 @@ static StructInitInfo module = {
     0,                                  /* checkInit                      */
     0,                                  /* preSave                        */
     0,                                  /* postSave                       */
-    0                                   /* postRestore                    */
+    0,                                  /* postRestore                    */
+    "src/pperm.c",                      /* filename                       */
+    1                                   /* isGapRootRelative              */
 };
 
 StructInitInfo * InitInfoPPerm ( void )
diff --git a/src/string.c b/src/string.c
index c005c70..9be43bd 100644
--- a/src/string.c
+++ b/src/string.c
@@ -629,7 +629,6 @@ Obj CopyString (
     return copy;
 }
 
-
 /****************************************************************************
 **
 *F  CopyStringCopy( <list>, <mut> ) . . . . . . . . . .  copy a copied string
@@ -1407,6 +1406,39 @@ Int IsStringObject (
 
 /****************************************************************************
 **
+*F  CopyToStringRep( <string> )  . . copy a string to the string representation
+**
+**  'CopyToStringRep' copies the string <string> to a new string in string
+**  representation.
+*/
+Obj CopyToStringRep(
+    Obj                 string )
+{
+    Int                 lenString;      /* length of the string            */
+    Obj                 elm;            /* one element of the string       */
+    Obj                 copy;           /* temporary string                */
+    Int                 i;              /* loop variable                   */
+
+    lenString = LEN_LIST(string);
+    copy = NEW_STRING(lenString);
+
+    if ( IS_STRING_REP(string) ) {
+        memcpy(ADDR_OBJ(copy), ADDR_OBJ(string), SIZE_OBJ(string));
+        /* XXX no error checks? */
+    } else {
+        /* copy the string to the string representation                     */
+        for ( i = 1; i <= lenString; i++ ) {
+            elm = ELMW_LIST( string, i );
+            CHARS_STRING(copy)[i-1] = *((UChar*)ADDR_OBJ(elm));
+        } 
+        CHARS_STRING(copy)[lenString] = '\0';
+    }
+    CHANGED_BAG(copy);
+    return (copy);
+}
+
+/****************************************************************************
+**
 *F  ConvString( <string> )  . . convert a string to the string representation
 **
 **  'ConvString' converts the string <list> to the string representation.
@@ -1559,6 +1591,25 @@ Obj FuncIS_STRING_REP (
 
 /****************************************************************************
 **
+*F  FuncCOPY_TO_STRING_REP( <self>, <obj> ) . copy a string into string rep
+*/
+Obj FuncCOPY_TO_STRING_REP (
+    Obj                 self,
+    Obj                 obj )
+{
+    /* check whether <obj> is a string                                  */
+    if (!IS_STRING(obj)) {
+        obj = ErrorReturnObj(
+            "ConvString: <string> must be a string (not a %s)",
+            (Int)TNAM_OBJ(obj), 0L,
+            "you can replace <string> via 'return <string>;'" );
+        return FuncCOPY_TO_STRING_REP( self, obj );
+    }
+    return CopyToStringRep(obj);
+}
+
+/****************************************************************************
+**
 *F  FuncPOSITION_SUBSTRING( <self>,  <string>, <substr>, <off> ) .  position of
 **  substring
 **  
@@ -1688,7 +1739,7 @@ Obj FuncNormalizeWhitespace (
 **  from <rem> in <string> in place 
 **    
 */ 
-UInt1 REMCHARLIST[257];
+
 Obj FuncRemoveCharacters (
 			      Obj     self,
 			      Obj     string,
@@ -1696,6 +1747,7 @@ Obj FuncRemoveCharacters (
 {
   UInt1  *s;
   Int i, j, len;
+  UInt1 REMCHARLIST[257] = {0};
 
   /* check whether <string> is a string                                  */
   if ( ! IsStringConv( string ) ) {
@@ -1715,11 +1767,6 @@ Obj FuncRemoveCharacters (
     return FuncRemoveCharacters( self, string, rem );
   }
   
-  /* reset REMCHARLIST (in case of previous error) */
-  if (REMCHARLIST[256] != 0) {
-    for(i=0; i<257; i++) REMCHARLIST[i] = 0;
-  }
-  
   /* set REMCHARLIST by setting positions of characters in rem to 1 */
   len = GET_LEN_STRING(rem);
   s = CHARS_STRING(rem);
@@ -1741,12 +1788,6 @@ Obj FuncRemoveCharacters (
   SET_LEN_STRING(string, i);
   SHRINK_STRING(string);
 
-  /* unset REMCHARLIST  */
-  len = GET_LEN_STRING(rem);
-  s = CHARS_STRING(rem);
-  for(i=0; i<len; i++) REMCHARLIST[s[i]] = 0;
-  REMCHARLIST[256] = 0;
-
   return (Obj)0;
 }
 
@@ -2309,6 +2350,9 @@ static StructGVarFunc GVarFuncs [] = {
     { "CONV_STRING", 1, "string",
       FuncCONV_STRING, "src/string.c:CONV_STRING" },
 
+    { "COPY_TO_STRING_REP", 1, "string",
+      FuncCOPY_TO_STRING_REP, "src/string.c:COPY_TO_STRING_REP" },
+
     { "CHAR_INT", 1, "integer",
       FuncCHAR_INT, "src/string.c:CHAR_INT" },
 
diff --git a/src/string.h b/src/string.h
index f5e60bb..29c7437 100644
--- a/src/string.h
+++ b/src/string.h
@@ -234,6 +234,17 @@ extern Int IsString (
 
 /****************************************************************************
 **
+*F  CopyToStringRep( <string> )  . . copy a string to the string representation
+**
+**  'CopyToStringRep' copies the string <string> to a new string in string
+**  representation.
+*/
+extern Obj CopyToStringRep(
+            Obj                 string );
+
+
+/****************************************************************************
+**
 *F  ConvString( <string> )  . . convert a string to the string representation
 **
 **  'ConvString' converts the string <list> to the string representation.
diff --git a/src/system.c b/src/system.c
index ee88c27..6d921ae 100644
--- a/src/system.c
+++ b/src/system.c
@@ -33,7 +33,7 @@
 
 #include        "system.h"              /* system dependent part           */
 
-
+#include        "gap.h"                 /* get UserHasQUIT                 */
 
 #include        "sysfiles.h"            /* file input/output               */
 #include        "gasman.h"            
@@ -68,10 +68,10 @@
 /****************************************************************************
 **
 *V  SyKernelVersion  . . . . . . . . . . . . . . . . name of the architecture
-** do not edit the following line. Occurences of `4.7.5' and `today'
+** do not edit the following line. Occurences of `4.7.7' and `today'
 ** will be replaced by string matching by distribution wrapping scripts.
 */
-const Char * SyKernelVersion = "4.7.5";
+const Char * SyKernelVersion = "4.7.7";
 
 /****************************************************************************
 *V  SyWindowsPath  . . . . . . . . . . . . . . . . . default path for Windows
@@ -1466,6 +1466,11 @@ void SySleep ( UInt secs )
 **  The function 'SyExit' must perform all the neccessary cleanup operations.
 **  If ret is 0 'SyExit' should signal to a calling proccess that all is  ok.
 **  If ret is 1 'SyExit' should signal a  failure  to  the  calling proccess.
+**
+**  If the user calls 'QUIT_GAP' with a value, then the global variable
+**  'UserHasQUIT' will be set, and their requested return value will be
+**  in 'UserHasQUITReturnValue'. If the return value would be 0, we check
+**  this calue and use it instead.
 */
 void SyExit (
     UInt                ret )
@@ -1480,8 +1485,12 @@ void SyExit (
   }
 
 #endif
-
-    exit( (int)ret );
+    if(ret == 0) {
+        exit(UserHasQUITReturnValue);
+    }
+    else {
+        exit( (int)ret );
+    }
 }
 
 /****************************************************************************
diff --git a/src/trans.c b/src/trans.c
index a925e8b..59898ab 100644
--- a/src/trans.c
+++ b/src/trans.c
@@ -38,24 +38,6 @@
 #define MIN(a,b)          (a<b?a:b)
 #define MAX(a,b)          (a<b?b:a)
 
-#define IMG_TRANS(f)       (*(Obj*)(ADDR_OBJ(f)))
-#define KER_TRANS(f)       (*((Obj*)(ADDR_OBJ(f))+1))
-#define EXT_TRANS(f)       (*((Obj*)(ADDR_OBJ(f))+2))
-
-#define NEW_TRANS2(deg)     NewBag(T_TRANS2, deg*sizeof(UInt2)+3*sizeof(Obj))
-#define ADDR_TRANS2(f)      ((UInt2*)((Obj*)(ADDR_OBJ(f))+3))
-#define DEG_TRANS2(f)       ((UInt)(SIZE_OBJ(f)-3*sizeof(Obj))/sizeof(UInt2))
-#define RANK_TRANS2(f)      (IMG_TRANS(f)==NULL?INIT_TRANS2(f):LEN_PLIST(IMG_TRANS(f)))
-
-#define NEW_TRANS4(deg)     NewBag(T_TRANS4, deg*sizeof(UInt4)+3*sizeof(Obj))
-#define ADDR_TRANS4(f)      ((UInt4*)((Obj*)(ADDR_OBJ(f))+3))
-#define DEG_TRANS4(f)       ((UInt)(SIZE_OBJ(f)-3*sizeof(Obj))/sizeof(UInt4))
-#define RANK_TRANS4(f)      (IMG_TRANS(f)==NULL?INIT_TRANS4(f):LEN_PLIST(IMG_TRANS(f)))
-
-#define IS_TRANS(f)       (TNUM_OBJ(f)==T_TRANS2||TNUM_OBJ(f)==T_TRANS4)
-#define RANK_TRANS(f)     (TNUM_OBJ(f)==T_TRANS2?RANK_TRANS2(f):RANK_TRANS4(f))
-#define DEG_TRANS(f)      (TNUM_OBJ(f)==T_TRANS2?DEG_TRANS2(f):DEG_TRANS4(f))
-
 // TmpTrans is the same as TmpPerm
 
 Obj TmpTrans;
@@ -84,7 +66,7 @@ static inline UInt4 * ResizeInitTmpTrans( UInt len ){
 }
 
 /* find rank, canonical trans same kernel, and img set (unsorted) */
-static UInt INIT_TRANS2(Obj f){ 
+extern UInt INIT_TRANS2(Obj f){ 
   UInt    deg, rank, i, j;
   UInt2   *ptf;
   UInt4   *pttmp;
@@ -93,7 +75,7 @@ static UInt INIT_TRANS2(Obj f){
   deg=DEG_TRANS2(f);
   
   if(deg==0){//special case for degree 0
-    img=NEW_PLIST(T_PLIST_EMPTY, 0);
+    img=NEW_PLIST(T_PLIST_EMPTY+IMMUTABLE, 0);
     SET_LEN_PLIST(img, 0);
     IMG_TRANS(f)=img;
     KER_TRANS(f)=img;
@@ -127,8 +109,7 @@ static UInt INIT_TRANS2(Obj f){
   return rank;
 }
 
-
-static UInt INIT_TRANS4(Obj f){ 
+extern UInt INIT_TRANS4(Obj f){ 
   UInt    deg, rank, i, j;
   UInt4   *ptf;
   UInt4   *pttmp;
@@ -137,7 +118,7 @@ static UInt INIT_TRANS4(Obj f){
   deg=DEG_TRANS4(f);
   
   if(deg==0){//special case for degree 0
-    img=NEW_PLIST(T_PLIST_EMPTY, 0);
+    img=NEW_PLIST(T_PLIST_EMPTY+IMMUTABLE, 0);
     SET_LEN_PLIST(img, 0);
     IMG_TRANS(f)=img;
     KER_TRANS(f)=img;
@@ -323,41 +304,44 @@ Obj FuncDegreeOfTransformation(Obj self, Obj f){
   UInt4   *ptf4;
   Obj     ext;
 
-  ext=EXT_TRANS(f);
-  if(ext!=NULL){
-    return ext;
-  } else if(TNUM_OBJ(f)==T_TRANS2){ 
-    n=DEG_TRANS2(f);
-    ptf2=ADDR_TRANS2(f);
-    if(ptf2[n-1]!=n-1){
-      ext=INTOBJ_INT(n);
-    } else {
-      deg=0;
-      for(i=0;i<n;i++){ 
-        if(ptf2[i]>i&&ptf2[i]+1>deg){
-          deg=ptf2[i]+1;
-        } else if(ptf2[i]<i&&i+1>deg){
-          deg=i+1;
-        }
-      }  
-      ext=INTOBJ_INT(deg);
+  if(TNUM_OBJ(f)==T_TRANS2){ 
+    ext=EXT_TRANS(f);
+    if(ext == NULL){ 
+      n=DEG_TRANS2(f);
+      ptf2=ADDR_TRANS2(f);
+      if(ptf2[n-1]!=n-1){
+        ext=INTOBJ_INT(n);
+      } else {
+        deg=0;
+        for(i=0;i<n;i++){ 
+          if(ptf2[i]>i&&ptf2[i]+1>deg){
+            deg=ptf2[i]+1;
+          } else if(ptf2[i]<i&&i+1>deg){
+            deg=i+1;
+          }
+        }  
+        ext=INTOBJ_INT(deg);
+      }
     }
     return ext;
   } else if (TNUM_OBJ(f)==T_TRANS4){
-    n=DEG_TRANS4(f);
-    ptf4=ADDR_TRANS4(f);
-    if(ptf4[n-1]!=n-1){
-      ext=INTOBJ_INT(n);
-    } else {
-      deg=0;
-      for(i=0;i<n;i++){ 
-        if(ptf4[i]>i&&ptf4[i]+1>deg){
-          deg=ptf4[i]+1;
-        } else if(ptf4[i]<i&&i+1>deg){
-          deg=i+1;
-        }
-      }  
-      ext=INTOBJ_INT(deg);
+    ext=EXT_TRANS(f);
+    if(ext == NULL){ 
+      n=DEG_TRANS4(f);
+      ptf4=ADDR_TRANS4(f);
+      if(ptf4[n-1]!=n-1){
+        ext=INTOBJ_INT(n);
+      } else {
+        deg=0;
+        for(i=0;i<n;i++){ 
+          if(ptf4[i]>i&&ptf4[i]+1>deg){
+            deg=ptf4[i]+1;
+          } else if(ptf4[i]<i&&i+1>deg){
+            deg=i+1;
+          }
+        }  
+        ext=INTOBJ_INT(deg);
+      }
     }
     return ext;
   }
@@ -779,7 +763,7 @@ Obj FuncIMAGE_SET_TRANS_INT (Obj self, Obj f, Obj n){
   if(m==deg){
     return FuncIMAGE_SET_TRANS(self, f);
   } else if(m==0){
-    new=NEW_PLIST(T_PLIST_EMPTY, 0);
+    new=NEW_PLIST(T_PLIST_EMPTY+IMMUTABLE, 0);
     SET_LEN_PLIST(new, 0);
     return new;
   } else if(m<deg){
@@ -840,7 +824,7 @@ Obj FuncIMAGE_TRANS (Obj self, Obj f, Obj n ){
   m=INT_INTOBJ(n);
 
   if(m==0){
-    out=NEW_PLIST(T_PLIST_EMPTY, 0);
+    out=NEW_PLIST(T_PLIST_EMPTY+IMMUTABLE, 0);
     SET_LEN_PLIST(out, 0);
     return out;
   }
@@ -932,7 +916,7 @@ Obj FuncPREIMAGES_TRANS_INT (Obj self, Obj f, Obj pt){
 
   deg=DEG_TRANS(f);
 
-  if(INT_INTOBJ(pt)>deg){
+  if((UInt) INT_INTOBJ(pt)>deg){
     out=NEW_PLIST(T_PLIST_CYC, 1);
     SET_LEN_PLIST(out, 1);
     SET_ELM_PLIST(out, 1, pt);
@@ -951,7 +935,9 @@ Obj FuncPREIMAGES_TRANS_INT (Obj self, Obj f, Obj pt){
     ptf4=ADDR_TRANS4(f);
     for(j=0;j<deg;j++) if(ptf4[j]==i) SET_ELM_PLIST(out, ++nr, INTOBJ_INT(j+1));
   }
-
+  if(nr==0){
+    RetypeBag(out, T_PLIST_EMPTY);
+  }
   SET_LEN_PLIST(out, (Int) nr);
   SHRINK_PLIST(out, (Int) nr);
   return out;
@@ -964,8 +950,7 @@ Obj FuncAS_TRANS_PERM_INT(Obj self, Obj p, Obj deg){
   UInt2   *ptp2, *ptf2;
   UInt4   *ptp4, *ptf4;
   Obj     f, img, *ptimg;
-  UInt    def, dep, i, min;
-  Int     n;
+  UInt    def, dep, i, min, n;
   
   n=INT_INTOBJ(deg);
   if(n==0) return IdentityTrans;
@@ -1553,7 +1538,7 @@ Obj FuncINV_LIST_TRANS(Obj self, Obj list, Obj f){
     ptg2=ADDR_TRANS2(g);
     
     for(j=0;j<deg;j++) ptg2[j]=j;
-    for(j=1;j<=LEN_LIST(list);j++){
+    for(j=1;j<=(UInt) LEN_LIST(list);j++){
       i=INT_INTOBJ(ELM_LIST(list, j))-1;
       if(i<deg) ptg2[ptf2[i]]=i;
     }
@@ -1566,7 +1551,7 @@ Obj FuncINV_LIST_TRANS(Obj self, Obj list, Obj f){
     
     i=INT_INTOBJ(ELM_LIST(list, 1))-1;
     for(j=0;j<deg;j++) ptg4[j]=j;
-    for(j=1;j<=LEN_LIST(list);j++){
+    for(j=1;j<=(UInt) LEN_LIST(list);j++){
       i=INT_INTOBJ(ELM_LIST(list, j))-1;
       if(i<deg) ptg4[ptf4[i]]=i;
     }
@@ -1929,10 +1914,16 @@ Obj FuncPOW_KER_PERM(Obj self, Obj ker, Obj p){
   Obj     out;
   UInt4   *ptcnj, *ptlkp, *ptp4;
   UInt2   *ptp2;
-
+  
   len=LEN_LIST(ker);
-  out=NEW_PLIST(T_PLIST_CYC+IMMUTABLE, len);
-  SET_LEN_PLIST(out, len);
+  if(len==0){
+    out=NEW_PLIST(T_PLIST_EMPTY+IMMUTABLE, len);
+    SET_LEN_PLIST(out, len);
+    return out;
+  } else {
+    out=NEW_PLIST(T_PLIST_CYC+IMMUTABLE, len);
+    SET_LEN_PLIST(out, len);
+  }
   
   ResizeTmpTrans(2*len);
   ptcnj = (UInt4*) ADDR_OBJ(TmpTrans);
@@ -1951,7 +1942,7 @@ Obj FuncPOW_KER_PERM(Obj self, Obj ker, Obj p){
         ptlkp[i]=0;
       }
       for(;i<len;i++){
-        ptcnj[i]=IMAGE(INT_INTOBJ(ELM_LIST(ker, i+1))-1, ptp2, dep);
+        ptcnj[i]=IMAGE((UInt) INT_INTOBJ(ELM_LIST(ker, i+1))-1, ptp2, dep);
         ptlkp[i]=0;
       }
 
@@ -1981,7 +1972,7 @@ Obj FuncPOW_KER_PERM(Obj self, Obj ker, Obj p){
         ptlkp[i]=0;
       }
       for(;i<len;i++){
-        ptcnj[i]=IMAGE(INT_INTOBJ(ELM_LIST(ker, i+1))-1, ptp4, dep);
+        ptcnj[i]=IMAGE((UInt) INT_INTOBJ(ELM_LIST(ker, i+1))-1, ptp4, dep);
         ptlkp[i]=0;
       }
 
@@ -2641,7 +2632,7 @@ Obj FuncLEFT_ONE_TRANS( Obj self, Obj f){
   n=1;
 
   for(i=1;n<=rank;i++){
-    if(INT_INTOBJ(ELM_PLIST(ker, i))==n){
+    if((UInt) INT_INTOBJ(ELM_PLIST(ker, i))==n){
       SET_ELM_PLIST(img, n++, INTOBJ_INT(i));
     }
   }
@@ -2668,7 +2659,7 @@ Obj FuncRIGHT_ONE_TRANS( Obj self, Obj f){
   j=1; n=0;
 
   for(i=0;i<deg;i++){
-    if(j<len&&i+1==INT_INTOBJ(ELM_PLIST(img, j+1))) j++;
+    if(j<len&&i+1==(UInt) INT_INTOBJ(ELM_PLIST(img, j+1))) j++;
     SET_ELM_PLIST(ker, ++n, INTOBJ_INT(j));
   }
   return FuncIDEM_IMG_KER_NC(self, img, ker);
@@ -3681,7 +3672,7 @@ Obj LQuoPerm4Trans4(Obj opL, Obj opR){
 
 /* i^f */
 Obj PowIntTrans2(Obj i, Obj f){
-  Int    img;
+  UInt    img;
  
   if(TNUM_OBJ(i)==T_INTPOS) return i; 
 
@@ -3703,7 +3694,7 @@ Obj PowIntTrans2(Obj i, Obj f){
 }
 
 Obj PowIntTrans4(Obj i, Obj f){
-  Int    img;
+  UInt    img;
  
   if(TNUM_OBJ(i)==T_INTPOS) return i; 
 
@@ -4382,7 +4373,9 @@ static StructInitInfo module = {
     0,                                  /* checkInit                      */
     0,                                  /* preSave                        */
     0,                                  /* postSave                       */
-    0                                   /* postRestore                    */
+    0,                                  /* postRestore                    */
+    "src/trans.c",                      /* filename                       */
+    1                                   /* isGapRootRelative              */
 };
 
 StructInitInfo * InitInfoTrans ( void )
diff --git a/src/trans.h b/src/trans.h
index 875973d..7d09877 100644
--- a/src/trans.h
+++ b/src/trans.h
@@ -36,6 +36,27 @@
 #ifndef GAP_TRANS_H
 #define GAP_TRANS_H
 
+extern UInt INIT_TRANS2(Obj f);
+extern UInt INIT_TRANS4(Obj f);
+
+#define IMG_TRANS(f)      (*(Obj*)(ADDR_OBJ(f)))
+#define KER_TRANS(f)      (*((Obj*)(ADDR_OBJ(f))+1))
+#define EXT_TRANS(f)      (*((Obj*)(ADDR_OBJ(f))+2))
+
+#define NEW_TRANS2(deg)   NewBag(T_TRANS2, deg*sizeof(UInt2)+3*sizeof(Obj))
+#define ADDR_TRANS2(f)    ((UInt2*)((Obj*)(ADDR_OBJ(f))+3))
+#define DEG_TRANS2(f)     ((UInt)(SIZE_OBJ(f)-3*sizeof(Obj))/sizeof(UInt2))
+#define RANK_TRANS2(f)    (IMG_TRANS(f)==NULL?INIT_TRANS2(f):LEN_PLIST(IMG_TRANS(f)))
+
+#define NEW_TRANS4(deg)   NewBag(T_TRANS4, deg*sizeof(UInt4)+3*sizeof(Obj))
+#define ADDR_TRANS4(f)    ((UInt4*)((Obj*)(ADDR_OBJ(f))+3))
+#define DEG_TRANS4(f)     ((UInt)(SIZE_OBJ(f)-3*sizeof(Obj))/sizeof(UInt4))
+#define RANK_TRANS4(f)    (IMG_TRANS(f)==NULL?INIT_TRANS4(f):LEN_PLIST(IMG_TRANS(f)))
+
+#define IS_TRANS(f)       (TNUM_OBJ(f)==T_TRANS2||TNUM_OBJ(f)==T_TRANS4)
+#define RANK_TRANS(f)     (TNUM_OBJ(f)==T_TRANS2?RANK_TRANS2(f):RANK_TRANS4(f))
+#define DEG_TRANS(f)      (TNUM_OBJ(f)==T_TRANS2?DEG_TRANS2(f):DEG_TRANS4(f))
+
 /****************************************************************************
 **
 *F  OnTuplesTrans( <tup>, <f> )  . . . .  operations on tuples of points
diff --git a/test-driver b/test-driver
index 32bf39e..d306056 100755
--- a/test-driver
+++ b/test-driver
@@ -1,7 +1,7 @@
 #! /bin/sh
 # test-driver - basic testsuite driver script.
 
-scriptversion=2012-06-27.10; # UTC
+scriptversion=2013-07-13.22; # UTC
 
 # Copyright (C) 2011-2013 Free Software Foundation, Inc.
 #
@@ -44,13 +44,12 @@ print_usage ()
 Usage:
   test-driver --test-name=NAME --log-file=PATH --trs-file=PATH
               [--expect-failure={yes|no}] [--color-tests={yes|no}]
-              [--enable-hard-errors={yes|no}] [--] TEST-SCRIPT
+              [--enable-hard-errors={yes|no}] [--]
+              TEST-SCRIPT [TEST-SCRIPT-ARGUMENTS]
 The '--test-name', '--log-file' and '--trs-file' options are mandatory.
 END
 }
 
-# TODO: better error handling in option parsing (in particular, ensure
-# TODO: $log_file, $trs_file and $test_name are defined).
 test_name= # Used for reporting.
 log_file=  # Where to save the output of the test script.
 trs_file=  # Where to save the metadata of the test run.
@@ -69,10 +68,23 @@ while test $# -gt 0; do
   --enable-hard-errors) enable_hard_errors=$2; shift;;
   --) shift; break;;
   -*) usage_error "invalid option: '$1'";;
+   *) break;;
   esac
   shift
 done
 
+missing_opts=
+test x"$test_name" = x && missing_opts="$missing_opts --test-name"
+test x"$log_file"  = x && missing_opts="$missing_opts --log-file"
+test x"$trs_file"  = x && missing_opts="$missing_opts --trs-file"
+if test x"$missing_opts" != x; then
+  usage_error "the following mandatory options are missing:$missing_opts"
+fi
+
+if test $# -eq 0; then
+  usage_error "missing argument"
+fi
+
 if test $color_tests = yes; then
   # Keep this in sync with 'lib/am/check.am:$(am__tty_colors)'.
   red='[0;31m' # Red.
diff --git a/test/Makefile.in b/test/Makefile.in
index 75ca128..f50e7dc 100644
--- a/test/Makefile.in
+++ b/test/Makefile.in
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.13.4 from Makefile.am.
+# Makefile.in generated by automake 1.14.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994-2013 Free Software Foundation, Inc.
@@ -589,14 +589,14 @@ distclean-compile:
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c $<
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c -o $@ $<
 
 .c.obj:
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c `$(CYGPATH_W) '$<'`
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
 
 .c.lo:
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(LTCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
-- 
2.1.1

