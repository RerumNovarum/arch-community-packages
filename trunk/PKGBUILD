# $Id$
# Maintainer: Sergej Pupykin <pupykin.s+arch@gmail.com>
# Contributor: Sergej Pupykin <pupykin.s+arch@gmail.com>

pkgname=pyicqt
pkgver=0.8.1.5
pkgrel=3
pkgdesc="jabber icq transport"
arch=(any)
url="http://code.google.com/p/pyicqt/"
license=('GPL')
backup=(etc/ejabberd/pyicq.xml)
depends=('python2' 'twisted')
replaces=(pyicq)
provides=(pyicq)
conflicts=(pyicq)
source=(http://pyicqt.googlecode.com/files/pyicqt-$pkgver.tar.gz \
        pyicq.rc \
	config.xml \
	ficq.patch \
	unicode-error-fix.diff)
md5sums=('d1c544f82ed416bbe987a5e419820fa8'
         'f5a7a999253286c0cd2bc6552ee885cd'
         '150501a11601763ce4ef12eb5649ef2a'
         '876a7b24f0ec17992f97dcf5d02a0d3a'
         'd480c2f59e7b42874aa4ecda04c1c0c0')

build()
{
  cd $srcdir

  # python2 fix
  for file in $(find . -name '*.py' -print); do
    sed -i 's_^#!.*/usr/bin/python_#!/usr/bin/python2_' $file
    sed -i 's_^#!.*/usr/bin/env.*python_#!/usr/bin/env python2_' $file
  done

#  patch $pkgname-$pkgver/src/tlib/oscar.py <$srcdir/ficq.patch
#  patch $pkgname-$pkgver/src/legacy/icqt.py <$srcdir/unicode-error-fix.diff

  install -d -m0755 $pkgdir/usr/lib
  cp -r $pkgname-$pkgver $pkgdir/usr/lib
  mv $pkgdir/usr/lib/$pkgname-$pkgver $pkgdir/usr/lib/$pkgname
  install -d -m0755 $pkgdir/var/spool/pyicqt
  install -D -m0644 ./config.xml $pkgdir/etc/ejabberd/pyicq.xml
  mv $pkgdir/usr/lib/$pkgname/config_example.xml $pkgdir/etc/ejabberd/pyicq_example.xml
  ln -s ../../../etc/ejabberd/pyicq.xml $pkgdir/usr/lib/$pkgname/config.xml
  install -D -m0755 pyicq.rc $pkgdir/etc/rc.d/pyicqt
}
