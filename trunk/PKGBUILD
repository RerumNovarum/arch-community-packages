# $Id$
# Maintainer: Sergej Pupykin <pupykin.s+arch@gmail.com>
# Maintainer: Antonio Rojas <nqn1976 @ gmail.com>
# Based on owncloud-git PKGBUILD by Alexander Ovsyannikov

pkgname=owncloud
pkgver=9.0.0beta2
pkgrel=1
pkgdesc="A cloud server to store your files centrally on a hardware controlled by you"
arch=('any')
url="http://owncloud.org/"
license=('GPL')
depends=('php-gd')
optdepends=('php-apache: to use the Apache web server'
	    'php-sqlite: to use the SQLite database backend'
	    'php-pgsql: to use the PostgreSQL database backend'
	    'php-ldap: LDAP authentication'
	    'php-intl'
	    'php-apcu'
	    'php-xcache'
	    'mariadb: to use the MySQL database backend'
	    'smbclient: to mount SAMBA shares'
	    'php-mcrypt'
#	    'php-imagick: file preview'
	    'ffmpeg: file preview'
	    'libreoffice: file preview')
makedepends=()
options=('!strip')
backup=('etc/webapps/owncloud/apache.example.conf')
validpgpkeys=('E3036906AD9F30807351FAC32D5D5E97F6978A26')
_watch="https://owncloud.org/changelog/"
#source=("http://download.owncloud.org/community/$pkgname-${pkgver}.tar.bz2"{,.asc}
source=("$pkgname-$pkgver.tar.gz::https://github.com/owncloud/core/archive/v$pkgver.tar.gz"
	"$pkgname-3rdparty-$pkgver.tar.gz::https://github.com/owncloud/3rdparty/archive/v$pkgver.tar.gz"
	"$pkgname-apps-$pkgver.tar.gz::https://github.com/owncloud/apps/archive/v$pkgver.tar.gz"
	"$pkgname-updater-$pkgver.tar.gz::https://github.com/owncloud/updater/archive/v$pkgver.tar.gz"
	"$pkgname-templateeditor-$pkgver.tar.gz::https://github.com/owncloud/templateeditor/archive/v$pkgver.tar.gz"
	"$pkgname-firstrunwizard-$pkgver.tar.gz::https://github.com/owncloud/firstrunwizard/archive/v$pkgver.tar.gz"
	"$pkgname-files_texteditor-$pkgver.tar.gz::https://github.com/owncloud/files_texteditor/archive/v$pkgver.tar.gz"
#	"$pkgname-files_locking-$pkgver.tar.gz::https://github.com/owncloud/files_locking/archive/v$pkgver.tar.gz"
	"$pkgname-files_pdfviewer-$pkgver.tar.gz::https://github.com/owncloud/files_pdfviewer/archive/v$pkgver.tar.gz"
	"$pkgname-activity-$pkgver.tar.gz::https://github.com/owncloud/activity/archive/v$pkgver.tar.gz"
	'apache.example.conf'
	"https://github.com/owncloud/3rdparty/commit/c03c864a03729956eec97dded790883c93dbd2e0.patch")
md5sums=('d2dd99cf24c536c76bf7501c6f37d6ca'
         '3d02493b1906761f49b93e29e3239af7'
         '1b1e6832fa9bfdf6886060e96daf2ed2'
         '7793c2d51811792d8f89a6cacf22227d'
         'af951ef7f2a53fc0735f417c175f565b'
         '59491d8e2ad2e6bc448bd1d332430ce0'
         'c4d9627209890f2cd55c4e75cbdea58a'
         'dfaef496df56ee5b17b9a16ab3978d71'
         '7a9b0251062215e783f8e9f028674c4b'
         '825bc73b2b661f90308dd9d5b570e481'
         '77bad9c67c6b358b4fca1115115f7e1f')

prepare() {
  cd $srcdir/core-$pkgver
  sed -i "s|'appstoreenabled'.*|'appstoreenabled' => false,|" config/config.sample.php
  rm -rf $srcdir/core-$pkgver/3rdparty
  mv $srcdir/3rdparty-$pkgver $srcdir/core-$pkgver/3rdparty
  mv $srcdir/apps-$pkgver/* $srcdir/core-$pkgver/apps

  # php7 fix
#  (cd $srcdir/core-$pkgver/3rdparty && patch -p1 -i $srcdir/c03c864a03729956eec97dded790883c93dbd2e0.patch)

#  for i in files_locking files_pdfviewer files_texteditor firstrunwizard \
  for i in files_pdfviewer files_texteditor firstrunwizard \
           templateeditor updater activity; do
    mv $srcdir/$i-$pkgver $srcdir/core-$pkgver/apps/$i
  done
  find . -type f -name .gitattributes -delete
  find . -type f -name .gitkeep -delete
  find . -type f -name .gitignore -delete
  find . -type f -name .gitmodules -delete
  find . -type f -name .travis.yml -delete
  find . -type d -name .git -exec rm -rf {} \;
  find ./apps -maxdepth 1 -type f -delete
}

package() {
  # install license
  install -d ${pkgdir}/usr/share/licenses/${pkgname}
  cp ${srcdir}/core-$pkgver/COPYING-* ${pkgdir}/usr/share/licenses/${pkgname}

  # install project
  install -d ${pkgdir}/usr/share/webapps/
  cp -a ${srcdir}/core-$pkgver ${pkgdir}/usr/share/webapps/${pkgname}
  rm -rf ${pkgdir}/usr/share/webapps/${pkgname}/tests

  # install apache config file
  install -d  ${pkgdir}/etc/webapps/${pkgname}
  install -m 644 ${srcdir}/apache.example.conf  ${pkgdir}/etc/webapps/${pkgname}

  # move config to /etc
  mv ${pkgdir}/usr/share/webapps/owncloud/config ${pkgdir}/etc/webapps/${pkgname}/config
  chown -R http:http ${pkgdir}/etc/webapps/${pkgname}
  ln -s /etc/webapps/${pkgname}/config ${pkgdir}/usr/share/webapps/owncloud/config
  chown -R root:http ${pkgdir}/usr/share/webapps/${pkgname}

  find ${pkgdir}/usr/share/webapps/owncloud -type f -exec chmod 0644 {} \;
  find ${pkgdir}/usr/share/webapps/owncloud -type d -exec chmod 0755 {} \;
#  find ${pkgdir}/etc/webapps/owncloud -type f -print0 | xargs -0 chmod 0640
#  find ${pkgdir}/etc/webapps/owncloud -type d -print0 | xargs -0 chmod 0750

  chmod a+x ${pkgdir}/usr/share/webapps/${pkgname}/occ
}
