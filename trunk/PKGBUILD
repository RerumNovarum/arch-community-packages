# $Id$
# Maintainer: SÃ©bastien "Seblu" Luttringer <seblu@archlinux.org>
# Contributor: Frederik Schwan frederik dot schwan at linux dot com>

pkgname=unifi
pkgver=3.2.1
pkgrel=1
pkgdesc='Centralized management system for Ubiquiti UniFi AP'
arch=('any')
url='https://community.ubnt.com/unifi'
license=('unknown')
depends=('mongodb' 'jre7-openjdk-headless')
makedepends=('jdk7-openjdk')
conflicts=('tomcat-native')
install=unifi.install
source=("UniFi-$pkgver.zip::http://dl.ubnt.com/unifi/$pkgver/UniFi.unix.zip"
        'unifi.service')
md5sums=('9b2d59e6be25db2210f4d85512315e6f'
         'a660012bdaa5c09a789e774514ae5c1e')

package() {
  # lib
  install -dm755 "$pkgdir/usr/lib/unifi"
  cp -r UniFi/{bin,dl,lib,webapps} "$pkgdir/usr/lib/unifi"
  # unjar
  pushd "$pkgdir/usr/lib/unifi/webapps"
  mkdir ROOT
  cd ROOT
  jar -xf ../ROOT.war
  rm ../ROOT.war
  popd

  # data
  install -dm750 "$pkgdir/var/lib/unifi"
  for _d in data run work; do
    install -dm750 "$pkgdir/var/lib/unifi/$_d"
    ln -s "../../../var/lib/unifi/$_d" "$pkgdir/usr/lib/unifi/$_d"
  done
  chown -R 113:113 "$pkgdir/var/lib/unifi"

  # log
  install -dm750 "$pkgdir/var/log/unifi"
  ln -s ../../../var/log/unifi "$pkgdir/usr/lib/unifi/logs"
  chown -R 113:113 "$pkgdir/var/log/unifi"

  # readme
  install -Dm644 UniFi/readme.txt "$pkgdir/usr/share/doc/$pkgname/README"

  # systemd
  install -Dm644 unifi.service "$pkgdir/usr/lib/systemd/system/unifi.service"
}

# vim:set ts=2 sw=2 ft=sh et:
